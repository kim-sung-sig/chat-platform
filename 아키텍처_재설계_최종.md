# ì±„íŒ… í”Œë«í¼ ì•„í‚¤í…ì²˜ ì¬ì„¤ê³„ (ìµœì¢…)

## ğŸ“‹ ëª©ì°¨
1. [ë¬¸ì œì  ë¶„ì„](#ë¬¸ì œì -ë¶„ì„)
2. [ì¬ì„¤ê³„ ë°©í–¥](#ì¬ì„¤ê³„-ë°©í–¥)
3. [ëª¨ë“ˆ êµ¬ì¡°](#ëª¨ë“ˆ-êµ¬ì¡°)
4. [ì˜ì¡´ì„± ë‹¤ì´ì–´ê·¸ë¨](#ì˜ì¡´ì„±-ë‹¤ì´ì–´ê·¸ë¨)
5. [ê° ëª¨ë“ˆ ìƒì„¸ ì„¤ê³„](#ê°-ëª¨ë“ˆ-ìƒì„¸-ì„¤ê³„)
6. [êµ¬í˜„ ì „ëµ](#êµ¬í˜„-ì „ëµ)
7. [ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„](#ë§ˆì´ê·¸ë ˆì´ì…˜-ë‹¨ê³„)

---

## ğŸ” ë¬¸ì œì  ë¶„ì„

### í˜„ì¬ êµ¬ì¡°ì˜ ë¬¸ì œ
1. **JPA ì„¤ì • ëˆ„ë½**: `chat-storage`ì— JPAê°€ ìˆì§€ë§Œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆì—ì„œ EntityScan ì„¤ì • ëˆ„ë½
2. **ë„ë©”ì¸ ë¡œì§ ë¶„ì‚°**: ë„ë©”ì¸ ì„œë¹„ìŠ¤ê°€ ê° ì„œë²„ ëª¨ë“ˆì— ë¶„ì‚°ë˜ì–´ ì¤‘ë³µ ë°œìƒ ê°€ëŠ¥
3. **ì±…ì„ ë¶ˆëª…í™•**: Entityë§Œ ìˆëŠ” storage vs ë„ë©”ì¸ ë¡œì§ì„ ê°€ì§„ ì„œë²„ ëª¨ë“ˆ ê°„ ê²½ê³„ ëª¨í˜¸
4. **ì˜ì¡´ì„± í˜¼ë€**: ì–´ë–¤ ëª¨ë“ˆì´ ì–´ë–¤ ì±…ì„ì„ ê°€ì ¸ì•¼ í•˜ëŠ”ì§€ ë¶ˆëª…í™•

---

## ğŸ¯ ì¬ì„¤ê³„ ë°©í–¥

### í•µì‹¬ ì›ì¹™
1. **DDD ê³„ì¸µ ë¶„ë¦¬**: Domain Layerì™€ Infrastructure Layer ëª…í™•íˆ ë¶„ë¦¬
2. **Hexagonal Architecture**: ë„ë©”ì¸ì„ ì¤‘ì‹¬ìœ¼ë¡œ, í¬íŠ¸/ì–´ëŒ‘í„° íŒ¨í„´ ì ìš©
3. **ë‹¨ì¼ ì±…ì„**: ê° ëª¨ë“ˆì€ ëª…í™•í•œ í•˜ë‚˜ì˜ ì±…ì„ë§Œ ê°€ì§
4. **ì˜ì¡´ì„± ì—­ì „**: ë„ë©”ì¸ì€ ì¸í”„ë¼ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ

### ìƒˆë¡œìš´ ëª¨ë“ˆ ì „ëµ
- **chat-domain**: ìˆœìˆ˜ ë„ë©”ì¸ ëª¨ë¸ + ë„ë©”ì¸ ì„œë¹„ìŠ¤ + Repository Interface
- **chat-storage**: JPA êµ¬í˜„ + Repository êµ¬í˜„ì²´ (chat-domainì— ì˜ì¡´)
- **ì„œë²„ ëª¨ë“ˆë“¤**: Application Layer (Use Case) + Presentation Layer

---

## ğŸ“¦ ëª¨ë“ˆ êµ¬ì¡°

```
chat-platform/
â”‚
â”œâ”€â”€ common/                        # ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬
â”‚   â”œâ”€â”€ common-util/               # ì˜ˆì™¸, ìƒìˆ˜, ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ common-auth/               # ì¸ì¦/ì¸ê°€ (JWT, Security)
â”‚   â””â”€â”€ common-logging/            # ë¡œê¹… (í–¥í›„ ELK ì—°ë™)
â”‚
â”œâ”€â”€ chat-domain/                   # ë„ë©”ì¸ ê³„ì¸µ (í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤)
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ channel/               # ì±„ë„ ë„ë©”ì¸ ëª¨ë¸
â”‚   â”‚   â”‚   â”œâ”€â”€ Channel.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ChannelId.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ChannelType.java
â”‚   â”‚   â”‚   â””â”€â”€ ChannelRepository.java (interface)
â”‚   â”‚   â”œâ”€â”€ message/               # ë©”ì‹œì§€ ë„ë©”ì¸ ëª¨ë¸
â”‚   â”‚   â”‚   â”œâ”€â”€ Message.java
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageId.java
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageType.java
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageStatus.java (enum)
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageContent.java
â”‚   â”‚   â”‚   â””â”€â”€ MessageRepository.java (interface)
â”‚   â”‚   â”œâ”€â”€ schedule/              # ìŠ¤ì¼€ì¤„ ë„ë©”ì¸ ëª¨ë¸
â”‚   â”‚   â”‚   â”œâ”€â”€ ScheduleRule.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ScheduleType.java (enum: ONE_TIME, RECURRING)
â”‚   â”‚   â”‚   â”œâ”€â”€ ScheduleStatus.java (enum)
â”‚   â”‚   â”‚   â””â”€â”€ ScheduleRuleRepository.java (interface)
â”‚   â”‚   â””â”€â”€ user/                  # ì‚¬ìš©ì ë„ë©”ì¸ ëª¨ë¸
â”‚   â”‚       â”œâ”€â”€ User.java
â”‚   â”‚       â””â”€â”€ UserId.java
â”‚   â””â”€â”€ service/                   # ë„ë©”ì¸ ì„œë¹„ìŠ¤
â”‚       â”œâ”€â”€ MessageDomainService.java
â”‚       â”œâ”€â”€ ChannelDomainService.java
â”‚       â””â”€â”€ ScheduleDomainService.java
â”‚
â”œâ”€â”€ chat-storage/                  # ì˜ì†ì„± ê³„ì¸µ (Infrastructure)
â”‚   â”œâ”€â”€ entity/                    # JPA Entity
â”‚   â”‚   â”œâ”€â”€ ChatChannelEntity.java
â”‚   â”‚   â”œâ”€â”€ ChatMessageEntity.java
â”‚   â”‚   â”œâ”€â”€ MessageReadEntity.java
â”‚   â”‚   â”œâ”€â”€ ScheduleRuleEntity.java
â”‚   â”‚   â””â”€â”€ OutboxEventEntity.java
â”‚   â”œâ”€â”€ repository/                # JPA Repository êµ¬í˜„
â”‚   â”‚   â”œâ”€â”€ JpaChatChannelRepository.java
â”‚   â”‚   â”œâ”€â”€ JpaChatMessageRepository.java
â”‚   â”‚   â”œâ”€â”€ JpaScheduleRuleRepository.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ adapter/                   # Domain Repository êµ¬í˜„ (Adapter)
â”‚   â”‚   â”œâ”€â”€ ChannelRepositoryAdapter.java
â”‚   â”‚   â”œâ”€â”€ MessageRepositoryAdapter.java
â”‚   â”‚   â””â”€â”€ ScheduleRepositoryAdapter.java
â”‚   â”œâ”€â”€ mapper/                    # Entity â†” Domain Model ë§¤í•‘
â”‚   â”‚   â”œâ”€â”€ ChannelMapper.java
â”‚   â”‚   â”œâ”€â”€ MessageMapper.java
â”‚   â”‚   â””â”€â”€ ScheduleMapper.java
â”‚   â””â”€â”€ config/
â”‚       â””â”€â”€ JpaConfig.java
â”‚
â”œâ”€â”€ chat-message-server/           # ë©”ì‹œì§€ ë°œì†¡ ì„œë²„
â”‚   â”œâ”€â”€ application/               # Use Case (Application Service)
â”‚   â”‚   â”œâ”€â”€ SendMessageUseCase.java
â”‚   â”‚   â”œâ”€â”€ PublishMessageUseCase.java
â”‚   â”‚   â””â”€â”€ MessageReadUseCase.java
â”‚   â”œâ”€â”€ presentation/              # REST Controller
â”‚   â”‚   â”œâ”€â”€ MessageController.java
â”‚   â”‚   â””â”€â”€ MessageReadController.java
â”‚   â”œâ”€â”€ infrastructure/            # Redis, Event Publisher
â”‚   â”‚   â”œâ”€â”€ RedisMessagePublisher.java
â”‚   â”‚   â””â”€â”€ MessageEventPublisher.java
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ SecurityConfig.java
â”‚       â””â”€â”€ RedisConfig.java
â”‚
â”œâ”€â”€ chat-system-server/            # ì‹œìŠ¤í…œ ê´€ë¦¬ ì„œë²„
â”‚   â”œâ”€â”€ application/               # Use Case
â”‚   â”‚   â”œâ”€â”€ channel/
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateChannelUseCase.java
â”‚   â”‚   â”‚   â”œâ”€â”€ JoinChannelUseCase.java
â”‚   â”‚   â”‚   â””â”€â”€ LeaveChannelUseCase.java
â”‚   â”‚   â”œâ”€â”€ message/
â”‚   â”‚   â”‚   â””â”€â”€ QueryMessageUseCase.java (Cursor ê¸°ë°˜ í˜ì´ì§•)
â”‚   â”‚   â””â”€â”€ schedule/
â”‚   â”‚       â”œâ”€â”€ CreateScheduleUseCase.java
â”‚   â”‚       â”œâ”€â”€ CancelScheduleUseCase.java
â”‚   â”‚       â””â”€â”€ ForcePublishScheduleUseCase.java
â”‚   â”œâ”€â”€ presentation/              # REST Controller
â”‚   â”‚   â”œâ”€â”€ ChannelController.java
â”‚   â”‚   â”œâ”€â”€ MessageQueryController.java
â”‚   â”‚   â””â”€â”€ ScheduleController.java
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ scheduler/             # Quartz ìŠ¤ì¼€ì¤„ëŸ¬
â”‚   â”‚   â”‚   â”œâ”€â”€ MessagePublishJob.java
â”‚   â”‚   â”‚   â”œâ”€â”€ QuartzSchedulerService.java
â”‚   â”‚   â”‚   â””â”€â”€ JobConcurrencyGuard.java
â”‚   â”‚   â””â”€â”€ client/
â”‚   â”‚       â””â”€â”€ MessageServerClient.java (REST í˜¸ì¶œ)
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ QuartzConfig.java
â”‚       â””â”€â”€ RestTemplateConfig.java
â”‚
â””â”€â”€ chat-websocket-server/         # WebSocket ì„œë²„
    â”œâ”€â”€ application/
    â”‚   â””â”€â”€ WebSocketMessageHandler.java
    â”œâ”€â”€ infrastructure/
    â”‚   â”œâ”€â”€ session/
    â”‚   â”‚   â””â”€â”€ WebSocketSessionManager.java (Redis ê¸°ë°˜)
    â”‚   â””â”€â”€ subscriber/
    â”‚       â””â”€â”€ RedisMessageSubscriber.java
    â””â”€â”€ config/
        â”œâ”€â”€ WebSocketConfig.java
        â””â”€â”€ RedisSubscriberConfig.java
```

---

## ğŸ”— ì˜ì¡´ì„± ë‹¤ì´ì–´ê·¸ë¨

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ common-util â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ common-auth â”‚         â”‚ common-logging â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  chat-domain    â”‚  â—„â”€â”€ ìˆœìˆ˜ ë„ë©”ì¸ (ì˜ì¡´ì„± ìµœì†Œ)
       â”‚ (domain models, â”‚
       â”‚  services,      â”‚
       â”‚  interfaces)    â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  chat-storage   â”‚  â—„â”€â”€ ì˜ì†ì„± êµ¬í˜„ (JPA)
       â”‚ (entities,      â”‚
       â”‚  repositories)  â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚                 â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ chat-message-    â”‚ â”‚ chat-system-   â”‚ â”‚ chat-websocket-   â”‚
â”‚ server           â”‚ â”‚ server         â”‚ â”‚ server            â”‚
â”‚ (ë©”ì‹œì§€ ë°œì†¡)     â”‚ â”‚ (ì‹œìŠ¤í…œ ê´€ë¦¬)   â”‚ â”‚ (ì‹¤ì‹œê°„ í†µì‹ )      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì˜ì¡´ì„± ê·œì¹™
1. **Domain â†’ ì•„ë¬´ê²ƒë„ ì˜ì¡´í•˜ì§€ ì•ŠìŒ** (common-utilë§Œ í—ˆìš©)
2. **Storage â†’ Domain ì˜ì¡´**
3. **Server ëª¨ë“ˆë“¤ â†’ Domain, Storage ì˜ì¡´**
4. **Server ëª¨ë“ˆ ê°„ ì§ì ‘ ì˜ì¡´ ê¸ˆì§€** (REST APIë‚˜ ì´ë²¤íŠ¸ë¡œ í†µì‹ )

---

## ğŸ“ ê° ëª¨ë“ˆ ìƒì„¸ ì„¤ê³„

### 1. chat-domain (ë„ë©”ì¸ ê³„ì¸µ)

#### ëª©ì 
- ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë„ë©”ì¸ ëª¨ë¸ ì •ì˜
- ì¸í”„ë¼(DB, í”„ë ˆì„ì›Œí¬)ì— ë…ë¦½ì 

#### ì£¼ìš” êµ¬ì„±ìš”ì†Œ

**1.1 Domain Models (Aggregate Root)**
```java
// Message Aggregate
public class Message {
    private MessageId id;
    private ChannelId channelId;
    private UserId senderId;
    private MessageContent content;
    private MessageType type;
    private MessageStatus status;  // ENUM: PENDING, SENT, DELIVERED, READ, FAILED
    private Instant createdAt;
    
    // ë„ë©”ì¸ ë¡œì§
    public void markAsSent() { ... }
    public void markAsDelivered() { ... }
    public void markAsRead(UserId userId) { ... }
    public boolean canBeEdited() { ... }
}

// Schedule Aggregate
public class ScheduleRule {
    private ScheduleId id;
    private ScheduleType type;  // ENUM: ONE_TIME, RECURRING
    private ScheduleStatus status;  // ENUM: PENDING, ACTIVE, EXECUTED, CANCELLED
    private Message message;
    private CronExpression cronExpression;  // for RECURRING
    private Instant scheduledAt;  // for ONE_TIME
    
    // ë„ë©”ì¸ ë¡œì§
    public void cancel() { ... }
    public void markAsExecuted() { ... }
    public boolean canBeExecuted() { ... }
}
```

**1.2 Repository Interfaces (Port)**
```java
public interface MessageRepository {
    Message save(Message message);
    Optional<Message> findById(MessageId id);
    List<Message> findByChannelId(ChannelId channelId, Cursor cursor, int limit);
}

public interface ScheduleRuleRepository {
    ScheduleRule save(ScheduleRule schedule);
    Optional<ScheduleRule> findById(ScheduleId id);
    Optional<ScheduleRule> findByIdWithLock(ScheduleId id);
}
```

**1.3 Domain Services**
```java
@Service
public class MessageDomainService {
    public Message createMessage(ChannelId channelId, UserId senderId, MessageContent content) {
        // ë„ë©”ì¸ ê·œì¹™ ê²€ì¦
        validateMessageContent(content);
        return Message.create(channelId, senderId, content);
    }
    
    public void validateMessageContent(MessageContent content) {
        // ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™
    }
}

@Service
public class ScheduleDomainService {
    public ScheduleRule createOneTimeSchedule(Message message, Instant scheduledAt) {
        return ScheduleRule.oneTime(message, scheduledAt);
    }
    
    public ScheduleRule createRecurringSchedule(Message message, CronExpression cron) {
        return ScheduleRule.recurring(message, cron);
    }
}
```

#### ì˜ì¡´ì„±
```gradle
dependencies {
    implementation project(':common-util')
    // ì™¸ë¶€ ì˜ì¡´ì„± ìµœì†Œí™”
}
```

---

### 2. chat-storage (ì˜ì†ì„± ê³„ì¸µ)

#### ëª©ì 
- Domain Repository Interfaceì˜ êµ¬í˜„
- JPA Entityì™€ Domain Model ê°„ ë³€í™˜
- ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ì¶”ìƒí™”

#### ì£¼ìš” êµ¬ì„±ìš”ì†Œ

**2.1 JPA Entities**
```java
@Entity
@Table(name = "chat_messages")
public class ChatMessageEntity {
    @Id
    private String id;
    
    @Column(name = "channel_id")
    private String channelId;
    
    @Column(name = "sender_id")
    private String senderId;
    
    @Enumerated(EnumType.STRING)
    private MessageStatus status;
    
    @Enumerated(EnumType.STRING)
    private MessageType type;
    
    // ... JPA ì „ìš© í•„ë“œ
}
```

**2.2 Repository Implementations (Adapter)**
```java
@Repository
@RequiredArgsConstructor
public class MessageRepositoryAdapter implements MessageRepository {
    private final JpaChatMessageRepository jpaRepository;
    private final MessageMapper mapper;
    
    @Override
    public Message save(Message message) {
        ChatMessageEntity entity = mapper.toEntity(message);
        ChatMessageEntity saved = jpaRepository.save(entity);
        return mapper.toDomain(saved);
    }
    
    @Override
    public Optional<Message> findById(MessageId id) {
        return jpaRepository.findById(id.getValue())
            .map(mapper::toDomain);
    }
}
```

**2.3 Mappers**
```java
@Component
public class MessageMapper {
    public ChatMessageEntity toEntity(Message domain) {
        // Domain â†’ Entity ë³€í™˜
    }
    
    public Message toDomain(ChatMessageEntity entity) {
        // Entity â†’ Domain ë³€í™˜
    }
}
```

**2.4 JPA Configuration**
```java
@Configuration
@EnableJpaRepositories(basePackages = "com.example.chat.storage.repository")
@EntityScan(basePackages = "com.example.chat.storage.entity")
public class JpaConfig {
    // JPA ì„¤ì •
}
```

#### ì˜ì¡´ì„±
```gradle
dependencies {
    implementation project(':common-util')
    implementation project(':chat-domain')
    
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    runtimeOnly 'org.postgresql:postgresql'
}
```

---

### 3. chat-message-server (ë©”ì‹œì§€ ë°œì†¡ ì„œë²„)

#### ëª©ì 
- ë©”ì‹œì§€ ë°œì†¡ API ì œê³µ
- ë©”ì‹œì§€ ì €ì¥ ë° Redis Pub/Sub ë°œí–‰

#### ì£¼ìš” Use Cases
```java
@Service
@RequiredArgsConstructor
public class SendMessageUseCase {
    private final MessageRepository messageRepository;
    private final MessageDomainService messageDomainService;
    private final ChannelRepository channelRepository;
    private final RedisMessagePublisher redisPublisher;
    
    @Transactional
    public MessageResponse execute(SendMessageCommand command) {
        // 1. ì±„ë„ ì¡°íšŒ
        Channel channel = channelRepository.findById(command.channelId())
            .orElseThrow(() -> new ChannelNotFoundException(command.channelId()));
        
        // 2. ê¶Œí•œ ê²€ì¦ (Early Return)
        if (!channel.isMember(command.senderId())) {
            throw new UnauthorizedAccessException("Not a member");
        }
        
        // 3. ë„ë©”ì¸ ì„œë¹„ìŠ¤ë¥¼ í†µí•œ ë©”ì‹œì§€ ìƒì„±
        Message message = messageDomainService.createMessage(
            command.channelId(),
            command.senderId(),
            command.content()
        );
        
        // 4. ì €ì¥
        Message saved = messageRepository.save(message);
        
        // 5. Redis ë°œí–‰
        redisPublisher.publish(saved);
        
        // 6. ì‘ë‹µ
        return MessageResponse.from(saved);
    }
}
```

#### ì˜ì¡´ì„±
```gradle
dependencies {
    implementation project(':common-util')
    implementation project(':common-auth')
    implementation project(':common-logging')
    implementation project(':chat-domain')
    implementation project(':chat-storage')
    
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-security'
}
```

---

### 4. chat-system-server (ì‹œìŠ¤í…œ ê´€ë¦¬ ì„œë²„)

#### ëª©ì 
- ì±„íŒ…ë°© ê´€ë¦¬ (ìƒì„±, ì°¸ì—¬, ì¡°íšŒ)
- ë©”ì‹œì§€ ì¡°íšŒ (Cursor ê¸°ë°˜ í˜ì´ì§•)
- ì˜ˆì•½ ë©”ì‹œì§€ ê´€ë¦¬ (Quartz ìŠ¤ì¼€ì¤„ëŸ¬)

#### ì£¼ìš” Use Cases

**4.1 ë©”ì‹œì§€ ì¡°íšŒ (Cursor ê¸°ë°˜)**
```java
@Service
@RequiredArgsConstructor
public class QueryMessageUseCase {
    private final MessageRepository messageRepository;
    private final ChannelRepository channelRepository;
    
    @Transactional(readOnly = true)
    public MessagePageResponse execute(QueryMessageCommand command) {
        // 1. ì±„ë„ ì¡°íšŒ
        Channel channel = channelRepository.findById(command.channelId())
            .orElseThrow(() -> new ChannelNotFoundException(command.channelId()));
        
        // 2. ê¶Œí•œ ê²€ì¦
        if (!channel.isMember(command.userId())) {
            throw new UnauthorizedAccessException("Not a member");
        }
        
        // 3. Cursor ê¸°ë°˜ ì¡°íšŒ
        List<Message> messages = messageRepository.findByChannelId(
            command.channelId(),
            command.cursor(),
            command.limit()
        );
        
        // 4. ë‹¤ìŒ ì»¤ì„œ ìƒì„±
        Cursor nextCursor = messages.isEmpty() ? null : 
            Cursor.from(messages.get(messages.size() - 1));
        
        return MessagePageResponse.of(messages, nextCursor);
    }
}
```

**4.2 ì˜ˆì•½ ë©”ì‹œì§€ (ë‹¨ë°œì„±)**
```java
@Service
@RequiredArgsConstructor
public class CreateOneTimeScheduleUseCase {
    private final ScheduleRuleRepository scheduleRepository;
    private final MessageDomainService messageDomainService;
    private final ScheduleDomainService scheduleDomainService;
    private final QuartzSchedulerService quartzService;
    
    @Transactional
    public ScheduleResponse execute(CreateOneTimeScheduleCommand command) {
        // 1. ë©”ì‹œì§€ ìƒì„± (ë„ë©”ì¸ ì„œë¹„ìŠ¤)
        Message message = messageDomainService.createMessage(
            command.channelId(),
            command.senderId(),
            command.content()
        );
        
        // 2. ìŠ¤ì¼€ì¤„ ìƒì„± (ë„ë©”ì¸ ì„œë¹„ìŠ¤)
        ScheduleRule schedule = scheduleDomainService.createOneTimeSchedule(
            message,
            command.scheduledAt()
        );
        
        // 3. ì €ì¥
        ScheduleRule saved = scheduleRepository.save(schedule);
        
        // 4. Quartz Job ë“±ë¡
        quartzService.scheduleOneTimeJob(saved);
        
        return ScheduleResponse.from(saved);
    }
}
```

**4.3 ì˜ˆì•½ ë©”ì‹œì§€ (ì£¼ê¸°ì )**
```java
@Service
@RequiredArgsConstructor
public class CreateRecurringScheduleUseCase {
    private final ScheduleRuleRepository scheduleRepository;
    private final MessageDomainService messageDomainService;
    private final ScheduleDomainService scheduleDomainService;
    private final QuartzSchedulerService quartzService;
    
    @Transactional
    public ScheduleResponse execute(CreateRecurringScheduleCommand command) {
        // 1. ë©”ì‹œì§€ í…œí”Œë¦¿ ìƒì„±
        Message messageTemplate = messageDomainService.createMessage(
            command.channelId(),
            command.senderId(),
            command.content()
        );
        
        // 2. ì£¼ê¸° ìŠ¤ì¼€ì¤„ ìƒì„±
        ScheduleRule schedule = scheduleDomainService.createRecurringSchedule(
            messageTemplate,
            command.cronExpression()
        );
        
        // 3. ì €ì¥
        ScheduleRule saved = scheduleRepository.save(schedule);
        
        // 4. Quartz Cron Job ë“±ë¡
        quartzService.scheduleRecurringJob(saved);
        
        return ScheduleResponse.from(saved);
    }
}
```

**4.4 ê°•ì œ ë°œì†¡ (ë™ì‹œì„± ì œì–´)**
```java
@Service
@RequiredArgsConstructor
public class ForcePublishScheduleUseCase {
    private final ScheduleRuleRepository scheduleRepository;
    private final MessageServerClient messageClient;
    private final QuartzSchedulerService quartzService;
    
    @Transactional
    public void execute(ForcePublishCommand command) {
        // 1. ë¹„ê´€ì  ë½ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
        ScheduleRule schedule = scheduleRepository
            .findByIdWithLock(command.scheduleId())
            .orElseThrow(() -> new ScheduleNotFoundException(command.scheduleId()));
        
        // 2. ìƒíƒœ ê²€ì¦ (Early Return)
        if (!schedule.canBeExecuted()) {
            throw new InvalidScheduleStateException("Cannot execute schedule");
        }
        
        // 3. ë‹¨ë°œì„±ì¸ ê²½ìš° Quartz Job ì‚­ì œ
        if (schedule.isOneTime()) {
            quartzService.deleteJob(schedule.getId());
        }
        
        // 4. ë©”ì‹œì§€ ë°œì†¡ (chat-message-server í˜¸ì¶œ)
        messageClient.sendMessage(schedule.getMessage());
        
        // 5. ìƒíƒœ ì—…ë°ì´íŠ¸
        schedule.markAsExecuted();
        scheduleRepository.save(schedule);
    }
}
```

#### ë™ì‹œì„± ì œì–´ ì „ëµ

**ë‹¨ë°œì„± ë©”ì‹œì§€**
- DB ë¹„ê´€ì  ë½ (`SELECT ... FOR UPDATE`)
- Message ìƒíƒœë¡œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
- Quartz Job ì‹¤í–‰ ì‹œ ìƒíƒœ ì²´í¬

**ì£¼ê¸°ì  ë©”ì‹œì§€**
- DB ë¹„ê´€ì  ë½ìœ¼ë¡œ ScheduleRule ë³´í˜¸
- ë©”ì‹œì§€ëŠ” ë§¤ë²ˆ ìƒˆë¡œ ìƒì„± (MessageId ì¤‘ë³µ ì—†ìŒ)
- Quartz Jobì—ì„œ `@DisallowConcurrentExecution` ì‚¬ìš©

```java
@DisallowConcurrentExecution
@Component
public class MessagePublishJob implements Job {
    @Override
    public void execute(JobExecutionContext context) {
        // ...
    }
}
```

#### ì˜ì¡´ì„±
```gradle
dependencies {
    implementation project(':common-util')
    implementation project(':common-auth')
    implementation project(':common-logging')
    implementation project(':chat-domain')
    implementation project(':chat-storage')
    
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-quartz'
    implementation 'org.springframework.boot:spring-boot-starter-security'
}
```

---

### 5. chat-websocket-server (WebSocket ì„œë²„)

#### ëª©ì 
- WebSocket ì—°ê²° ê´€ë¦¬
- Redis Pub/Sub êµ¬ë… â†’ WebSocket ì „ì†¡

#### ì£¼ìš” êµ¬ì„±ìš”ì†Œ
```java
@Component
@RequiredArgsConstructor
public class RedisMessageSubscriber {
    private final WebSocketSessionManager sessionManager;
    
    @RedisListener(topic = "chat.message")
    public void onMessage(MessageEvent event) {
        // ì±„ë„ì˜ ëª¨ë“  ì„¸ì…˜ì— ì „ì†¡
        sessionManager.sendToChannel(event.getChannelId(), event);
    }
}

@Component
public class WebSocketSessionManager {
    private final RedisTemplate<String, String> redisTemplate;
    
    // Redis ê¸°ë°˜ ì„¸ì…˜ ê´€ë¦¬ (ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ëŒ€ì‘)
    public void registerSession(String sessionId, ChannelId channelId) { ... }
    public void sendToChannel(ChannelId channelId, MessageEvent event) { ... }
}
```

#### ì˜ì¡´ì„±
```gradle
dependencies {
    implementation project(':common-util')
    implementation project(':common-auth')
    implementation project(':chat-domain')  // ì½ê¸° ì „ìš©
    
    implementation 'org.springframework.boot:spring-boot-starter-websocket'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
}
```

---

## ğŸš€ êµ¬í˜„ ì „ëµ

### Phase 1: Domain ê³„ì¸µ êµ¬ì¶•
1. `chat-domain` ëª¨ë“ˆ ìƒì„±
2. Aggregate Root ì •ì˜ (Message, Channel, ScheduleRule)
3. Repository Interface ì •ì˜
4. Domain Service êµ¬í˜„
5. Value Objects ë° Enums ì •ì˜

### Phase 2: Storage ê³„ì¸µ êµ¬ì¶•
1. `chat-storage` ëª¨ë“ˆ ìˆ˜ì •
2. JPA Entity ìƒì„±/ìˆ˜ì •
3. Repository Adapter êµ¬í˜„
4. Mapper êµ¬í˜„
5. JPA Configuration ì„¤ì •

### Phase 3: ì„œë²„ ëª¨ë“ˆ ë¦¬íŒ©í† ë§
1. `chat-message-server` Use Case êµ¬í˜„
2. `chat-system-server` Use Case êµ¬í˜„
3. Controller ë ˆì´ì–´ ì •ë¦¬
4. ê° ì„œë²„ì˜ Infrastructure êµ¬í˜„

### Phase 4: í†µí•© ë° í…ŒìŠ¤íŠ¸
1. í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±
2. API ë¬¸ì„œí™”
3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

---

## ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„

### Step 1: chat-domain ëª¨ë“ˆ ìƒì„±
```bash
# 1. ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p chat-domain/src/main/java/com/example/chat/domain

# 2. build.gradle ìƒì„±
# 3. Domain Models ì´ê´€
# 4. Repository Interfaces ì •ì˜
```

### Step 2: chat-storage ë¦¬íŒ©í† ë§
```bash
# 1. ê¸°ì¡´ Entity ê²€í†  ë° ì •ë¦¬
# 2. Adapter íŒ¨í‚¤ì§€ ìƒì„±
# 3. Mapper êµ¬í˜„
# 4. JpaConfig ìˆ˜ì • (EntityScan, EnableJpaRepositories)
```

### Step 3: ì„œë²„ ëª¨ë“ˆ ë¦¬íŒ©í† ë§
```bash
# 1. Application íŒ¨í‚¤ì§€ ìƒì„± (Use Case)
# 2. ê¸°ì¡´ Service â†’ Use Caseë¡œ ë³€ê²½
# 3. Domain ì˜ì¡´ì„± ì¶”ê°€
# 4. ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°
```

### Step 4: ì˜ì¡´ì„± ì •ë¦¬
```bash
# 1. ê° ëª¨ë“ˆì˜ build.gradle ìˆ˜ì •
# 2. settings.gradleì— chat-domain ì¶”ê°€
# 3. ìˆœí™˜ ì˜ì¡´ì„± ì œê±°
```

### Step 5: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
```bash
# 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
# 2. í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# 3. API í…ŒìŠ¤íŠ¸
```

---

## ğŸ“Š ê¸°ëŒ€ íš¨ê³¼

### 1. ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬
- Domain: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- Storage: ì˜ì†ì„±
- Server: Use Case + API

### 2. ì¬ì‚¬ìš©ì„± í–¥ìƒ
- Domainê³¼ StorageëŠ” ëª¨ë“  ì„œë²„ì—ì„œ ê³µí†µ ì‚¬ìš©
- ì¤‘ë³µ ì½”ë“œ ì œê±°

### 3. í…ŒìŠ¤íŠ¸ ìš©ì´ì„±
- Domainì€ ìˆœìˆ˜ Javaë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- StorageëŠ” Mockìœ¼ë¡œ í…ŒìŠ¤íŠ¸
- ServerëŠ” í†µí•© í…ŒìŠ¤íŠ¸

### 4. í™•ì¥ì„±
- ìƒˆë¡œìš´ ì„œë²„ ì¶”ê°€ ì‹œ Domain/Storage ì¬ì‚¬ìš©
- ë©”ì‹œì§€ íƒ€ì… ì¶”ê°€ ì‹œ Domainë§Œ ìˆ˜ì •

### 5. ìœ ì§€ë³´ìˆ˜ì„±
- ê° ê³„ì¸µì˜ ë³€ê²½ì´ ë‹¤ë¥¸ ê³„ì¸µì— ì˜í–¥ ìµœì†Œí™”
- ì½”ë“œ íŒŒì•…ì´ ì‰¬ì›€

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. âœ… ì•„í‚¤í…ì²˜ ë¬¸ì„œ ì‘ì„± ì™„ë£Œ
2. â¬œ chat-domain ëª¨ë“ˆ ìƒì„± ë° êµ¬í˜„
3. â¬œ chat-storage ë¦¬íŒ©í† ë§
4. â¬œ chat-message-server ë¦¬íŒ©í† ë§
5. â¬œ chat-system-server ë¦¬íŒ©í† ë§
6. â¬œ chat-websocket-server ë¦¬íŒ©í† ë§
7. â¬œ í†µí•© í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
8. â¬œ API ë¬¸ì„œí™”

---

## ğŸ“š ì°¸ê³  ìë£Œ
- DDD (Domain-Driven Design)
- Hexagonal Architecture (Ports & Adapters)
- Clean Architecture
- CQRS Pattern
