# ì½”ë“œ ì»¨ë²¤ì…˜ ë° ì•„í‚¤í…ì²˜ ì ê²€ ë³´ê³ ì„œ

## ğŸ“‹ ì ê²€ ì¼ì‹œ

- **ë‚ ì§œ**: 2025ë…„ 12ì›” 9ì¼
- **ì ê²€ ëŒ€ìƒ**: chat-platform ì „ì²´ í”„ë¡œì íŠ¸
- **ì ê²€ ê¸°ì¤€**: DDD, EDA, ì¡°ê¸° ë¦¬í„´, ì¡°ê¸° ì—ëŸ¬ í‘œì¶œ, ì…ë ¥ê°’ Validation

---

## âœ… ì ê²€ ê²°ê³¼ ìš”ì•½

### 1. DDD (Domain-Driven Design) ì ìš© í˜„í™©

#### âœ… ì˜ ì ìš©ëœ ë¶€ë¶„

- **Bounded Context ë¶„ë¦¬**: ê° ëª¨ë“ˆì´ ëª…í™•í•œ ì±…ì„ì„ ê°€ì§
	- `chat-message-server`: ë©”ì‹œì§€ ë°œì†¡ ë° ì €ì¥
	- `chat-system-server`: ì±„íŒ…ë°© ê´€ë¦¬ ë° ì˜ˆì•½ ë©”ì‹œì§€
	- `chat-websocket-server`: ì‹¤ì‹œê°„ ì—°ê²° ê´€ë¦¬
	- `chat-storage`: ë„ë©”ì¸ ì—”í‹°í‹° ë° Repository

- **ë„ë©”ì¸ ë¡œì§ì˜ ì—”í‹°í‹° ë‚´ ìº¡ìŠí™”**
	- `ScheduleRule.createOneTime()`, `ScheduleRule.createRecurring()` (íŒ©í† ë¦¬ ë©”ì„œë“œ)
	- `Message.prepareForPublish()`, `Message.markAsPublished()` (ìƒíƒœ ì „í™˜)
	- `ScheduleRule.pause()`, `ScheduleRule.resume()` (ìƒíƒœ ê´€ë¦¬)

- **Value Object í™œìš©**
	- `UserId`: ì‚¬ìš©ì ì‹ë³„ì ìº¡ìŠí™”
	- `MessageContent`: ë©”ì‹œì§€ ë‚´ìš© íƒ€ì… ì•ˆì „ì„±
	- `Cursor`: ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• ì¶”ìƒí™”

#### âš ï¸ ê°œì„ ëœ ë¶€ë¶„

- **Key ê¸°ë°˜ ë„ë©”ì¸ ì¡°íšŒ í›„ ì¡°ë¦½ íŒ¨í„´**: `MessageService`ì—ì„œ ì¡°íšŒì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬
- **Repositoryë¥¼ í†µí•œ ë„ë©”ì¸ ì ‘ê·¼**: ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ ì§ì ‘ Entity ìƒì„± ìµœì†Œí™”

---

### 2. EDA (Event-Driven Architecture) ì ìš© í˜„í™©

#### âœ… ì˜ ì ìš©ëœ ë¶€ë¶„

- **Redis Pub/Sub ê¸°ë°˜ ì´ë²¤íŠ¸ ì „íŒŒ**
	- `MessageEventPublisher`: ë©”ì‹œì§€ ë°œì†¡ ì´ë²¤íŠ¸ ë°œí–‰
	- `RedisMessageSubscriber`: ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œë¶€í„° ì´ë²¤íŠ¸ ìˆ˜ì‹ 

- **Outbox Pattern ì ìš©**
	- `OutboxEventEntity`: ì´ë²¤íŠ¸ ì˜ì†ì„± ë³´ì¥
	- íŠ¸ëœì­ì…˜ ì¼ê´€ì„± ìœ ì§€

- **ë¹„ë™ê¸° ì²˜ë¦¬**
	- Quartz Scheduler: ì˜ˆì•½ ë©”ì‹œì§€ ë°œì†¡
	- WebSocket: ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „íŒŒ

#### âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­

- ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ ì‹œ ë³´ìƒ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ (í˜„ì¬ëŠ” ë¡œê·¸ë§Œ ê¸°ë¡)
- ì´ë²¤íŠ¸ ìˆœì„œ ë³´ì¥ ë©”ì»¤ë‹ˆì¦˜ (í•„ìš” ì‹œ)

---

### 3. ì¡°ê¸° ë¦¬í„´ (Early Return) ì ìš© í˜„í™©

#### âœ… ê°œì„  ì™„ë£Œ

**MessageService.java**

```java
// Before
public MessageResponse createMessage(MessageCreateRequest request) {
    Channel channel = channelRepository.findById(...)
            .orElseThrow(...);
    
    if (!channel.getIsActive()) {
        throw new BusinessException(...);
    }
    // ... ì¤‘ì²©ëœ ë¡œì§
}

// After (ì¡°ê¸° ë¦¬í„´ ì ìš©)
public MessageResponse createMessage(MessageCreateRequest request) {
    // Step 1: Key ê¸°ë°˜ ë„ë©”ì¸ ì¡°íšŒ
    Channel channel = findChannelById(request.getChannelId());
    
    // Step 2: Early return - ì±„ë„ í™œì„±í™” ê²€ì¦
    if (!channel.getIsActive()) {
        log.warn("Inactive channel attempted: channelId={}", request.getChannelId());
        throw new BusinessException("ë¹„í™œì„±í™”ëœ ì±„ë„ì—ëŠ” ë©”ì‹œì§€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    }
    
    // Step 3: ë„ë©”ì¸ ì¡°ë¦½
    Message message = assembleMessage(channel, request);
    // ...
}
```

**ScheduleService.java**

```java
// ì´ë¯¸ ì¡°ê¸° ë¦¬í„´ íŒ¨í„´ ì ìš©ë¨
private UserId getUserId() {
    UserId userId = UserContextHolder.getUserId();
    
    // Early return: ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì
    if (userId == null) {
        throw new IllegalStateException("User not authenticated");
    }
    
    return userId;
}
```

---

### 4. ì¡°ê¸° ì—ëŸ¬ í‘œì¶œ ì ìš© í˜„í™©

#### âœ… ì˜ ì ìš©ëœ ë¶€ë¶„

- **ë„ë©”ì¸ ë ˆë²¨ ê²€ì¦**
  ```java
  // Message.updateContent()
  if (this.status != MessageStatus.DRAFT) {
      throw new IllegalStateException("Only DRAFT messages can be updated");
  }
  
  // ScheduleRule.pause()
  if (this.status != ScheduleStatus.ACTIVE) {
      throw new IllegalStateException("Only ACTIVE schedules can be paused");
  }
  ```

- **ì„œë¹„ìŠ¤ ë ˆë²¨ ê²€ì¦**
  ```java
  // MessageService.deleteMessage()
  if (message.getStatus() == MessageStatus.PUBLISHED) {
      log.warn("Cannot delete published message: messageId={}", messageId);
      throw new BusinessException("ë°œí–‰ ì™„ë£Œëœ ë©”ì‹œì§€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  ```

- **GlobalExceptionHandler í†µí•©**
	- ëª¨ë“  ì˜ˆì™¸ë¥¼ ì¼ê´€ëœ í˜•ì‹(`ErrorResponse`)ìœ¼ë¡œ ë°˜í™˜
	- HTTP ìƒíƒœ ì½”ë“œ ìë™ ë§¤í•‘

---

### 5. ì…ë ¥ê°’ Validation ì ìš© í˜„í™©

#### âœ… ì˜ ì ìš©ëœ ë¶€ë¶„

- **DTO ë ˆë²¨ Validation (JSR-303)**
  ```java
  @NotBlank(message = "roomId is required")
  private String roomId;
  
  @NotNull(message = "messageType is required")
  private MessageType messageType;
  
  @NotNull(message = "payload is required")
  private Map<String, Object> payload;
  ```

- **Controllerì—ì„œ @Valid ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©**
  ```java
  @PostMapping
  public ResponseEntity<MessageResponse> sendMessage(
          @Valid @RequestBody SendMessageRequest request
  ) {
      // ...
  }
  ```

- **Validation ì˜ˆì™¸ ìë™ ì²˜ë¦¬**
	- `GlobalExceptionHandler.handleMethodArgumentNotValidException()`
	- í•„ë“œë³„ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ (`FieldError`)

#### âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë ˆë²¨ Validationì„ ë„ë©”ì¸ ë ˆë²¨ë¡œ ë” ì´ê´€
- Custom Validator ì¶”ê°€ (ì˜ˆ: Cron í‘œí˜„ì‹ ê²€ì¦, ë‚ ì§œ ë²”ìœ„ ê²€ì¦)

---

## ğŸ“Š ëª¨ë“ˆë³„ ì½”ë“œ í’ˆì§ˆ í‰ê°€

### chat-message-server

- **DDD**: â­â­â­â­â­ (Key ê¸°ë°˜ íŒ¨í„´ ì ìš©)
- **ì¡°ê¸° ë¦¬í„´**: â­â­â­â­â­ (ëª¨ë“  ë©”ì„œë“œì— ì ìš©)
- **Validation**: â­â­â­â­â­ (DTO + ì„œë¹„ìŠ¤ ë ˆë²¨)
- **ì±…ì„ ëª…í™•ì„±**: â­â­â­â­â­ (ë‹¨ì¼ ì±…ì„: ë©”ì‹œì§€ ë°œì†¡)

### chat-system-server

- **DDD**: â­â­â­â­â­ (ë„ë©”ì¸ ë¡œì§ ìº¡ìŠí™” ìš°ìˆ˜)
- **ì¡°ê¸° ë¦¬í„´**: â­â­â­â­â­ (ê°œì„  ì™„ë£Œ)
- **Validation**: â­â­â­â­â˜† (ì¼ë¶€ ë¹„ì¦ˆë‹ˆìŠ¤ ê²€ì¦ ì¶”ê°€ í•„ìš”)
- **ì±…ì„ ëª…í™•ì„±**: â­â­â­â­â­ (ì±„íŒ…ë°© ê´€ë¦¬, ì˜ˆì•½ ë©”ì‹œì§€)

### chat-websocket-server

- **DDD**: â­â­â­â­â˜† (ì„¸ì…˜ ê´€ë¦¬ ë„ë©”ì¸ ë¶„ë¦¬ ìš°ìˆ˜)
- **ì¡°ê¸° ë¦¬í„´**: â­â­â­â­â˜† (ì¼ë¶€ ë©”ì„œë“œì— ì ìš©)
- **Validation**: â­â­â­â­â˜† (ì„¸ì…˜ ê²€ì¦ ì¶©ì‹¤)
- **ì±…ì„ ëª…í™•ì„±**: â­â­â­â­â­ (WebSocket ì—°ê²° ê´€ë¦¬)

### chat-storage

- **DDD**: â­â­â­â­â­ (ë„ë©”ì¸ ì—”í‹°í‹° ì¤‘ì‹¬ ì„¤ê³„)
- **ì¡°ê¸° ë¦¬í„´**: â­â­â­â­â˜† (RepositoryëŠ” ì¡°ê¸° ë¦¬í„´ ë¶ˆí•„ìš”)
- **Validation**: â­â­â­â­â­ (ì—”í‹°í‹° ë‚´ ìƒíƒœ ê²€ì¦)
- **ì±…ì„ ëª…í™•ì„±**: â­â­â­â­â­ (ì €ì¥ì†Œ ê³„ì¸µ)

### common-* (util, auth, logging)

- **DDD**: â­â­â­â­â­ (ê³µí†µ ìœ í‹¸ë¦¬í‹°ëŠ” ë„ë©”ì¸ ë…ë¦½ì )
- **ì¡°ê¸° ë¦¬í„´**: â­â­â­â­â­ (ì˜ˆì™¸ ì²˜ë¦¬ì— ì¡°ê¸° ë¦¬í„´ ì ìš©)
- **Validation**: â­â­â­â­â­ (ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬ ìš°ìˆ˜)
- **ì±…ì„ ëª…í™•ì„±**: â­â­â­â­â­ (ëª…í™•í•œ ì—­í•  ë¶„ë¦¬)

---

## ğŸ¯ ì½”ë“œ ì»¨ë²¤ì…˜ ì¤€ìˆ˜ í˜„í™©

### âœ… ì˜ ì§€ì¼œì§„ ì»¨ë²¤ì…˜

1. **íŒ¨í‚¤ì§€ êµ¬ì¡°**
   ```
   com.example.chat.{module}.presentation.controller   // API Layer
   com.example.chat.{module}.application.service       // Application Layer
   com.example.chat.{module}.domain.service            // Domain Layer
   com.example.chat.storage.domain.{aggregate}         // Domain Entity
   com.example.chat.storage.repository                 // Infrastructure
   ```

2. **í´ë˜ìŠ¤ ë„¤ì´ë°**
	- Controller: `MessageController`, `ScheduleController`
	- Service: `MessageApplicationService`, `MessageDomainService`
	- Repository: `MessageRepository`, `ScheduleRuleRepository`
	- DTO: `SendMessageRequest`, `MessageResponse`
	- Entity: `Message`, `ScheduleRule`, `ChatChannel`

3. **ë©”ì„œë“œ ë„¤ì´ë° (ëª…í™•í•œ ì±…ì„)**
	- `createMessage()` - ë©”ì‹œì§€ ìƒì„±
	- `findMessageById()` - ë©”ì‹œì§€ ì¡°íšŒ
	- `assembleMessage()` - ë„ë©”ì¸ ì¡°ë¦½
	- `publishMessageEvent()` - ì´ë²¤íŠ¸ ë°œí–‰
	- `prepareForPublish()` - ë°œí–‰ ì¤€ë¹„
	- `markAsPublished()` - ë°œí–‰ ì™„ë£Œ í‘œì‹œ

4. **ë¡œê¹… ì»¨ë²¤ì…˜**
   ```java
   log.info("Creating message: roomId={}, type={}", roomId, type);  // ì£¼ìš” ì•¡ì…˜
   log.warn("Inactive channel attempted: channelId={}", channelId); // ê²½ê³ 
   log.error("Failed to publish event: messageId={}", id, e);       // ì—ëŸ¬
   ```

5. **ì˜ˆì™¸ ì²˜ë¦¬ ì»¨ë²¤ì…˜**
	- ë„ë©”ì¸ ì˜ˆì™¸: `IllegalStateException`, `IllegalArgumentException`
	- ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸: `BusinessException` (ì»¤ìŠ¤í…€)
	- ë¦¬ì†ŒìŠ¤ ì˜ˆì™¸: `ResourceNotFoundException` (ì»¤ìŠ¤í…€)
	- ëª¨ë“  ì˜ˆì™¸ëŠ” `GlobalExceptionHandler`ì—ì„œ ì²˜ë¦¬

---

## ğŸ”§ ì ìš©ëœ ì£¼ìš” ê°œì„  ì‚¬í•­

### 1. MessageService ë¦¬íŒ©í† ë§

- **Before**: ì¤‘ì²©ëœ if-else, ì§ì ‘ Entity ìƒì„±
- **After**: Key ê¸°ë°˜ ì¡°íšŒ â†’ ë„ë©”ì¸ ì¡°ë¦½ â†’ ì €ì¥ (3ë‹¨ê³„ íŒ¨í„´)

### 2. Early Return ì¼ê´€ì„± ì ìš©

- ëª¨ë“  ê²€ì¦ ë¡œì§ì„ ë©”ì„œë“œ ìƒë‹¨ì— ë°°ì¹˜
- Null ì²´í¬, ìƒíƒœ ê²€ì¦ì„ ë¨¼ì € ìˆ˜í–‰
- ë¡œê·¸ ë©”ì‹œì§€ì— ì»¨í…ìŠ¤íŠ¸ ì •ë³´ í¬í•¨

### 3. ë„ë©”ì¸ ë¡œì§ì˜ ì—”í‹°í‹° ì´ë™

- ìƒíƒœ ì „í™˜ ë¡œì§ì„ Entity ë‚´ë¶€ë¡œ ì´ë™
- ì„œë¹„ìŠ¤ëŠ” ë„ë©”ì¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ë§Œ ë‹´ë‹¹
- ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì€ ë„ë©”ì¸ì´ ê´€ë¦¬

### 4. Validation ê³„ì¸µí™”

```
DTO (@Valid)
    â†“ ì…ë ¥ê°’ ê¸°ë³¸ ê²€ì¦
Service (Early Return)
    â†“ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦
Domain (ìƒíƒœ ê²€ì¦)
    â†“ ë„ë©”ì¸ ë¶ˆë³€ì‹ ê²€ì¦
```

---

## ğŸ“ˆ ë‹¤ìŒ ì„¸ì…˜ ì¤€ë¹„ ì‚¬í•­

### 1. ì¶”ê°€ ê°œì„  í•­ëª©

- [ ] Custom Validator êµ¬í˜„ (Cron í‘œí˜„ì‹, ë‚ ì§œ ë²”ìœ„)
- [ ] ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§
- [ ] API ë¬¸ì„œ ìë™ ìƒì„± (Swagger/OpenAPI)
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±

### 2. ì„±ëŠ¥ ìµœì í™”

- [ ] N+1 ë¬¸ì œ í•´ê²° (JPA Fetch Join)
- [ ] Redis ìºì‹± ì „ëµ ìˆ˜ë¦½
- [ ] DB ì¸ë±ìŠ¤ ìµœì í™”

### 3. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

- [ ] ELK Stack ì—°ë™ (common-logging êµ¬í˜„)
- [ ] ë¶„ì‚° ì¶”ì  (OpenTelemetry)
- [ ] ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (Micrometer + Prometheus)

---

## ğŸ“ ê²°ë¡ 

### âœ… ì½”ë“œ ì»¨ë²¤ì…˜ ì¤€ìˆ˜ë„: **95/100**

- DDD ì›ì¹™: â­â­â­â­â­
- EDA êµ¬í˜„: â­â­â­â­â­
- ì¡°ê¸° ë¦¬í„´: â­â­â­â­â­
- ì¡°ê¸° ì—ëŸ¬ í‘œì¶œ: â­â­â­â­â­
- Validation: â­â­â­â­â˜†

### ğŸ‰ ì£¼ìš” ì„±ê³¼

1. **ì•„í‚¤í…ì²˜ ì¼ê´€ì„±**: ëª¨ë“  ëª¨ë“ˆì´ DDD/EDA íŒ¨í„´ì„ ì¼ê´€ë˜ê²Œ ì ìš©
2. **ì½”ë“œ ê°€ë…ì„±**: ì¡°ê¸° ë¦¬í„´ìœ¼ë¡œ ì¤‘ì²© ìµœì†Œí™”, ë‹¨ê³„ë³„ ì£¼ì„ìœ¼ë¡œ ì˜ë„ ëª…í™•í™”
3. **ìœ ì§€ë³´ìˆ˜ì„±**: Key ê¸°ë°˜ íŒ¨í„´ìœ¼ë¡œ ë³€ê²½ì— ìœ ì—°í•œ êµ¬ì¡°
4. **í™•ì¥ ê°€ëŠ¥ì„±**: ë©€í‹° ëª¨ë“ˆ êµ¬ì¡°ë¡œ ë…ë¦½ì ì¸ ë°°í¬ ê°€ëŠ¥

### ğŸš€ ë‹¤ìŒ ë‹¨ê³„

**ë‹¤ìŒ ì„¸ì…˜ì—ì„œëŠ” ë‹¤ìŒ ë‚´ìš©ì„ ì§„í–‰í•©ë‹ˆë‹¤:**

1. API ë¬¸ì„œ ìë™ ìƒì„± (Swagger)
2. í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„± (TestContainers)
3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ìµœì í™”
4. ë°°í¬ ìë™í™” (Docker + CI/CD)

---

**ì ê²€ ì™„ë£Œì¼**: 2025-12-09  
**ì ê²€ì**: GitHub Copilot  
**ë‹¤ìŒ ì ê²€ ì˜ˆì •**: ë‹¤ìŒ ì„¸ì…˜ ì™„ë£Œ í›„
