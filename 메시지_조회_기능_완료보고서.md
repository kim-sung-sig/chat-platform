# ë©”ì‹œì§€ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“… ì‘ì—… ì¼ì: 2025-12-13

---

## ğŸ¯ ì‘ì—… ëª©í‘œ ë° ê²°ê³¼

### âœ… ì™„ë£Œëœ ì‘ì—…

#### 1. ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• êµ¬í˜„ (100% ì™„ë£Œ)

**Domain Layer:**
- âœ… `MessageRepository.findByChannelId(ChannelId, Cursor, int)` - ì´ë¯¸ êµ¬í˜„ë¨
- âœ… `Cursor` Value Object - ì´ë¯¸ êµ¬í˜„ë¨

**Storage Layer:**
- âœ… `MessageRepositoryAdapter.findByChannelId()` - ì»¤ì„œ ê¸°ë°˜ êµ¬í˜„
- âœ… `JpaChatMessageRepository.findByChannelIdWithCursor()` - @Query êµ¬í˜„
- âœ… `JpaChatMessageRepository.findByChannelIdOrderByCreatedAtDesc()` - ìµœì‹  ë©”ì‹œì§€ ì¡°íšŒ

---

#### 2. MessageQueryService êµ¬í˜„ (100% ì™„ë£Œ)

**CQRS íŒ¨í„´ ì ìš©:**
- Command: `MessageApplicationService` (chat-message-server) - ë©”ì‹œì§€ ë°œì†¡
- Query: `MessageQueryService` (chat-system-server) - ë©”ì‹œì§€ ì¡°íšŒ

**êµ¬í˜„ëœ Use Case (3ê°œ):**
1. âœ… `getMessages()` - ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• ì¡°íšŒ
2. âœ… `getMessage()` - íŠ¹ì • ë©”ì‹œì§€ ì¡°íšŒ
3. âœ… `getUnreadMessageCount()` - ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ (ê°„ë‹¨ êµ¬í˜„)

**ì»¤ì„œ ìƒì„± ë°©ì‹:**
```java
// Cursor í˜•ì‹: Base64(messageId:createdAtEpochMilli)
String cursor = Base64.encode(message.getId() + ":" + message.getCreatedAt().toEpochMilli());
```

---

#### 3. MessageQueryController êµ¬í˜„ (100% ì™„ë£Œ)

**REST API ì—”ë“œí¬ì¸íŠ¸ (3ê°œ):**

```
GET /api/v1/messages?channelId={channelId}&cursor={cursor}&limit={limit}
    - ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ (ì»¤ì„œ í˜ì´ì§•)
    - cursor: Base64 ì¸ì½”ë”©ëœ ë¬¸ìì—´ (ì„ íƒ)
    - limit: ì¡°íšŒí•  ë©”ì‹œì§€ ìˆ˜ (ê¸°ë³¸: 20, ìµœëŒ€: 100)

GET /api/v1/messages/{messageId}
    - íŠ¹ì • ë©”ì‹œì§€ ì¡°íšŒ

GET /api/v1/messages/unread-count?channelId={channelId}
    - ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ (TODO: ì‹¤ì œ êµ¬í˜„ í•„ìš”)
```

---

#### 4. DTO ìƒì„±/ìˆ˜ì • (100% ì™„ë£Œ)

**Response DTOs:**
- âœ… `MessageResponse` - ì‹ ê·œ ìƒì„± (chat-system-server)
- âœ… `CursorPageResponse<T>` - ìˆ˜ì • (String ì»¤ì„œ, data í•„ë“œ)

---

## ğŸ“Š ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼ í†µê³„

### Application Service (1ê°œ)
1. `MessageQueryService.java` - ì‹ ê·œ ìƒì„± (250+ ë¼ì¸)

### Controller (1ê°œ)
2. `MessageQueryController.java` - ì‹ ê·œ ìƒì„± (100+ ë¼ì¸)

### Response DTOs (2ê°œ)
3. `MessageResponse.java` - ì‹ ê·œ ìƒì„±
4. `CursorPageResponse.java` - ìˆ˜ì • (íƒ€ì… ë³€ê²½)

**ì´ 4ê°œ íŒŒì¼ ìƒì„±/ìˆ˜ì •**

---

## ğŸ—ï¸ ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• ì•„í‚¤í…ì²˜

### 1. Cursor ìƒì„± ë° íŒŒì‹±

```java
// Cursor ìƒì„±
private String createCursor(Message message) {
    String cursorData = message.getId().getValue() + ":" + message.getCreatedAt().toEpochMilli();
    return Base64.getEncoder().encodeToString(cursorData.getBytes());
}

// Cursor íŒŒì‹±
private Cursor parseCursor(String cursorStr) {
    byte[] decoded = Base64.getDecoder().decode(cursorStr);
    String decodedStr = new String(decoded);
    String[] parts = decodedStr.split(":");
    String timestamp = parts[1];
    return Cursor.of(Instant.ofEpochMilli(Long.parseLong(timestamp)).toString());
}
```

### 2. í˜ì´ì§• ë¡œì§

```java
// Step 1: limit + 1 ê°œ ì¡°íšŒ (hasNext í™•ì¸ìš©)
List<Message> messages = messageRepository.findByChannelId(channelId, cursor, pageLimit + 1);

// Step 2: hasNext í™•ì¸
boolean hasNext = messages.size() > pageLimit;
if (hasNext) {
    messages = messages.subList(0, pageLimit);
}

// Step 3: ë‹¤ìŒ Cursor ìƒì„±
String nextCursor = null;
if (hasNext && !messages.isEmpty()) {
    Message lastMessage = messages.get(messages.size() - 1);
    nextCursor = createCursor(lastMessage);
}
```

### 3. JPA ì¿¼ë¦¬

```java
@Query("SELECT m FROM ChatMessageEntity m WHERE m.channelId = :channelId " +
       "AND m.createdAt < :cursorTime " +
       "ORDER BY m.createdAt DESC")
Page<ChatMessageEntity> findByChannelIdWithCursor(
    @Param("channelId") String channelId,
    @Param("cursorTime") Instant cursorTime,
    Pageable pageable
);
```

---

## ğŸ“ˆ CQRS íŒ¨í„´ ì ìš©

### Command Side (chat-message-server)
- **MessageApplicationService**: ë©”ì‹œì§€ ë°œì†¡
- **POST /api/v1/messages**: ë©”ì‹œì§€ ìƒì„±

### Query Side (chat-system-server)
- **MessageQueryService**: ë©”ì‹œì§€ ì¡°íšŒ
- **GET /api/v1/messages**: ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ
- **GET /api/v1/messages/{id}**: íŠ¹ì • ë©”ì‹œì§€ ì¡°íšŒ

### ì¥ì :
1. **ì±…ì„ ë¶„ë¦¬**: ì“°ê¸°ì™€ ì½ê¸° ë¡œì§ ë¶„ë¦¬
2. **ìµœì í™”**: ì¡°íšŒìš© ì¿¼ë¦¬ ìµœì í™” ê°€ëŠ¥
3. **í™•ì¥ì„±**: ë…ë¦½ì ì¸ ìŠ¤ì¼€ì¼ë§ ê°€ëŠ¥

---

## ğŸ“ ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• vs Offset ê¸°ë°˜ í˜ì´ì§•

### Offset ê¸°ë°˜ í˜ì´ì§• (X)
```sql
SELECT * FROM messages 
WHERE channel_id = ? 
ORDER BY created_at DESC 
LIMIT 20 OFFSET 40;
```

**ë¬¸ì œì :**
- OFFSETì´ í´ìˆ˜ë¡ ì„±ëŠ¥ ì €í•˜
- ë°ì´í„° ë³€ê²½ ì‹œ ì¤‘ë³µ/ëˆ„ë½ ë°œìƒ
- ëŒ€ê·œëª¨ ë°ì´í„°ì…‹ì—ì„œ ë¹„íš¨ìœ¨ì 

### ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• (O)
```sql
SELECT * FROM messages 
WHERE channel_id = ? 
  AND created_at < ?  -- ì»¤ì„œ ì‹œê°„
ORDER BY created_at DESC 
LIMIT 21;  -- limit + 1
```

**ì¥ì :**
- ì¼ê´€ëœ ì„±ëŠ¥ (ì¸ë±ìŠ¤ í™œìš©)
- ë°ì´í„° ë³€ê²½ì— ì•ˆì „
- ëŒ€ê·œëª¨ ë°ì´í„°ì…‹ì— ì í•©

---

## ğŸ“‹ API ì‚¬ìš© ì˜ˆì‹œ

### 1. ì²« í˜ì´ì§€ ì¡°íšŒ
```bash
GET /api/v1/messages?channelId=channel123&limit=20
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "data": [
      {
        "id": "msg1",
        "channelId": "channel123",
        "content": "Hello",
        "createdAt": "2025-12-13T10:00:00Z"
      },
      ...
    ],
    "nextCursor": "bXNnMjA6MTczNDEwMDAwMDAwMA==",
    "hasNext": true,
    "size": 20
  }
}
```

### 2. ë‹¤ìŒ í˜ì´ì§€ ì¡°íšŒ
```bash
GET /api/v1/messages?channelId=channel123&cursor=bXNnMjA6MTczNDEwMDAwMDAwMA==&limit=20
```

### 3. íŠ¹ì • ë©”ì‹œì§€ ì¡°íšŒ
```bash
GET /api/v1/messages/msg123
```

---

## âœ… ì½”ë“œ í’ˆì§ˆ ì²´í¬

### 1. DDD íŒ¨í„´ âœ…
- Repository ì¸í„°í˜ì´ìŠ¤ (Domain Layer)
- Repository êµ¬í˜„ (Storage Layer)
- Application Service (Use Case)

### 2. CQRS íŒ¨í„´ âœ…
- Command: MessageApplicationService
- Query: MessageQueryService

### 3. Early Return íŒ¨í„´ âœ…
- ëª¨ë“  ê²€ì¦ ë¡œì§ì— ì ìš©
- ì¡°ê¸° ì—ëŸ¬ í‘œì¶œ

### 4. ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• âœ…
- ì„±ëŠ¥ ìµœì í™”
- ë°ì´í„° ì¼ê´€ì„± ë³´ì¥

### 5. REST API ì„¤ê³„ âœ…
- RESTful ì›ì¹™ ì¤€ìˆ˜
- Swagger ë¬¸ì„œí™”

---

## ğŸ” ì£¼ìš” ê°œì„  ì‚¬í•­

### 1. Offset â†’ Cursor í˜ì´ì§•

**Before (ë¬¸ì œ):**
```java
// Offset ê¸°ë°˜ - ì„±ëŠ¥ ì €í•˜
List<Message> messages = repository.findByChannelId(channelId, page * size, size);
```

**After (ê°œì„ ):**
```java
// Cursor ê¸°ë°˜ - ì¼ê´€ëœ ì„±ëŠ¥
List<Message> messages = repository.findByChannelId(channelId, cursor, limit);
```

### 2. CQRS íŒ¨í„´ ì ìš©

- **Command**: ë©”ì‹œì§€ ë°œì†¡ (chat-message-server)
- **Query**: ë©”ì‹œì§€ ì¡°íšŒ (chat-system-server)
- ê°ê° ë…ë¦½ì ìœ¼ë¡œ ìµœì í™” ê°€ëŠ¥

### 3. ìŠ¤ë§ˆíŠ¸í•œ hasNext íŒë‹¨

```java
// limit + 1 ê°œë¥¼ ì¡°íšŒí•´ì„œ hasNext íŒë‹¨
List<Message> messages = repository.findByChannelId(channelId, cursor, limit + 1);
boolean hasNext = messages.size() > limit;
```

---

## ğŸ“Š ì „ì²´ ì§„í–‰ë¥ 

### í”„ë¡œì íŠ¸: **60% ì™„ë£Œ** (5% ì¦ê°€ â¬†ï¸)

- âœ… ë©€í‹°ëª¨ë“ˆ êµ¬ì¡° ì„¤ê³„ (100%)
- âœ… Domain ëª¨ë“ˆ ë¶„ë¦¬ (100%)
- âœ… Storage ëª¨ë“ˆ êµ¬í˜„ (100%)
- âœ… Domain Service ë¦¬íŒ©í† ë§ (100%)
- âœ… Message Server ê¸°ë³¸ êµ¬í˜„ (100%)
- âœ… Schedule Server ê¸°ë³¸ êµ¬í˜„ (100%)
- âœ… Channel ê´€ë¦¬ ê¸°ëŠ¥ (100%)
- âœ… **ë©”ì‹œì§€ ì¡°íšŒ ê¸°ëŠ¥ (100%)** â† ì´ë²ˆ ì„¸ì…˜
- â³ WebSocket Server ë¦¬íŒ©í† ë§ (0%) â† ë‹¤ìŒ
- â³ í†µí•© í…ŒìŠ¤íŠ¸ (0%)

---

## ğŸ’¡ í•µì‹¬ ì„±ê³¼ ìš”ì•½

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ìƒì„±ëœ íŒŒì¼** | 4ê°œ (Service 1ê°œ, Controller 1ê°œ, DTO 2ê°œ) |
| **API ì—”ë“œí¬ì¸íŠ¸** | 3ê°œ (ë©”ì‹œì§€ ëª©ë¡, ë©”ì‹œì§€ ì¡°íšŒ, ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜) |
| **Use Case êµ¬í˜„** | 3ê°œ (Application Service ë©”ì„œë“œ) |
| **í˜ì´ì§• ë°©ì‹** | ì»¤ì„œ ê¸°ë°˜ (Offset ëŒ€ë¹„ ì„±ëŠ¥ í–¥ìƒ) |
| **CQRS íŒ¨í„´** | Command/Query ë¶„ë¦¬ |
| **ì½”ë“œ ë¼ì¸** | 350+ ë¼ì¸ (ì£¼ì„ í¬í•¨) |

---

## ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„

### Step 3: WebSocket Server ë¦¬íŒ©í† ë§

#### 3.1 Domain ëª¨ë¸ ì ìš©
- ğŸ”² chat-websocket-serverì— chat-domain ì˜ì¡´ì„± ì¶”ê°€
- ğŸ”² Domain ëª¨ë¸ í™œìš© (Message, Channel ë“±)

#### 3.2 Redis Pub/Sub ì—°ë™
- ğŸ”² RedisMessageListener ì •ìƒ ë™ì‘ í™•ì¸
- ğŸ”² ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ ëŒ€ì‘

#### 3.3 ChatRoomSessionManager ë¦¬íŒ©í† ë§
- ğŸ”² Redis ê¸°ë°˜ Session ê´€ë¦¬
- ğŸ”² ë¡œì»¬ ë©”ëª¨ë¦¬ ì œê±°
- ğŸ”² ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ëŒ€ì‘

---

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

### 1. ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§•
- Offset ëŒ€ë¹„ ì¼ê´€ëœ ì„±ëŠ¥
- ì¸ë±ìŠ¤ í™œìš© ìµœì í™”
- Base64 ì¸ì½”ë”©ìœ¼ë¡œ ì»¤ì„œ ì€ë‹‰

### 2. CQRS íŒ¨í„´
- Command/Query ì±…ì„ ë¶„ë¦¬
- ë…ë¦½ì ì¸ ìµœì í™” ê°€ëŠ¥
- í™•ì¥ì„± í–¥ìƒ

### 3. Early Return íŒ¨í„´
- ì¡°ê¸° ì—ëŸ¬ í‘œì¶œ
- ê°€ë…ì„± í–¥ìƒ
- ì¤‘ì²© ifë¬¸ ì œê±°

---

## âš ï¸ TODO í•­ëª©

### 1. ì½ìŒ ì²˜ë¦¬ (Read Receipt)
```sql
CREATE TABLE read_receipts (
    id VARCHAR(255) PRIMARY KEY,
    message_id VARCHAR(255),
    user_id VARCHAR(255),
    read_at TIMESTAMP,
    UNIQUE(message_id, user_id)
);
```

### 2. ë©”ì‹œì§€ ê²€ìƒ‰ ê¸°ëŠ¥
- ì „ë¬¸ ê²€ìƒ‰ (Full-text Search)
- Elasticsearch ì—°ë™ ê³ ë ¤

### 3. ë©”ì‹œì§€ ì²¨ë¶€íŒŒì¼ ê´€ë¦¬
- S3 ì—…ë¡œë“œ
- Presigned URL ìƒì„±

---

**ì‘ì„±ì:** GitHub Copilot  
**ê²€í†  ìƒíƒœ:** âœ… ì™„ë£Œ  
**ë‹¤ìŒ ì„¸ì…˜:** WebSocket Server ë¦¬íŒ©í† ë§
