# ë‹¤ìŒ ì„¸ì…˜ ì‹¤í–‰ ê³„íš

## ğŸ“… ê³„íš ì¼ì: 2025-12-13

---

## ğŸ¯ ì„¸ì…˜ ëª©í‘œ: Channel ê´€ë¦¬ & ë©”ì‹œì§€ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„

---

## ğŸ“‹ Step 1: Channel ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„

### 1.1 ChannelApplicationService ìƒì„±
**ìœ„ì¹˜:** `chat-system-server/src/main/java/com/example/chat/system/application/service/ChannelApplicationService.java`

**êµ¬í˜„ ë©”ì„œë“œ:**
```java
// ì±„ë„ ìƒì„±
public ChannelResponse createDirectChannel(CreateDirectChannelRequest request)
public ChannelResponse createGroupChannel(CreateGroupChannelRequest request)
public ChannelResponse createPublicChannel(CreatePublicChannelRequest request)
public ChannelResponse createPrivateChannel(CreatePrivateChannelRequest request)

// ì±„ë„ ë©¤ë²„ ê´€ë¦¬
public void addMemberToChannel(String channelId, String userId)
public void removeMemberFromChannel(String channelId, String userId)

// ì±„ë„ ì¡°íšŒ
public ChannelResponse getChannel(String channelId)
public List<ChannelResponse> getMyChannels()
public List<ChannelResponse> getPublicChannels()

// ì±„ë„ ìˆ˜ì •
public ChannelResponse updateChannelInfo(String channelId, UpdateChannelRequest request)
public void deactivateChannel(String channelId)
```

**DDD íŒ¨í„´ ì ìš©:**
1. Keyë¡œ Aggregate ì¡°íšŒ (Channel, User)
2. ChannelDomainService í˜¸ì¶œ (Aggregate ì „ë‹¬)
3. ì˜ì†í™”
4. ì´ë²¤íŠ¸ ë°œí–‰ (ì„ íƒ)
5. DTO ë³€í™˜

---

### 1.2 DTO ìƒì„±

**Request DTOs:**
- `CreateDirectChannelRequest` (user1Id, user2Id)
- `CreateGroupChannelRequest` (name, memberIds)
- `CreatePublicChannelRequest` (name, description)
- `CreatePrivateChannelRequest` (name, description, memberIds)
- `UpdateChannelRequest` (name, description)

**Response DTOs:**
- `ChannelResponse` (id, name, type, ownerId, memberCount, active, createdAt)
- `ChannelDetailResponse` (extends ChannelResponse + memberIds)

---

### 1.3 Controller ìƒì„±
**ìœ„ì¹˜:** `chat-system-server/src/main/java/com/example/chat/system/controller/ChannelController.java`

**ì—”ë“œí¬ì¸íŠ¸:**
```
POST   /api/v1/channels/direct
POST   /api/v1/channels/group
POST   /api/v1/channels/public
POST   /api/v1/channels/private
GET    /api/v1/channels/{channelId}
GET    /api/v1/channels/my
GET    /api/v1/channels/public
PUT    /api/v1/channels/{channelId}
DELETE /api/v1/channels/{channelId}
POST   /api/v1/channels/{channelId}/members
DELETE /api/v1/channels/{channelId}/members/{userId}
```

---

## ğŸ“‹ Step 2: ë©”ì‹œì§€ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„

### 2.1 ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• êµ¬í˜„

**MessageRepository í™•ì¥:**
```java
// ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§•
List<Message> findByChannelIdWithCursor(
    ChannelId channelId, 
    Cursor cursor, 
    int limit
);

// íŠ¹ì • ë©”ì‹œì§€ ì´ì „/ì´í›„ ì¡°íšŒ
List<Message> findByChannelIdBeforeMessage(
    ChannelId channelId, 
    MessageId messageId, 
    int limit
);

List<Message> findByChannelIdAfterMessage(
    ChannelId channelId, 
    MessageId messageId, 
    int limit
);
```

**Storage Layer êµ¬í˜„:**
- `JpaMessageRepository`ì— ì»¤ì„œ ê¸°ë°˜ ì¿¼ë¦¬ ì¶”ê°€
- `@Query` ì–´ë…¸í…Œì´ì…˜ í™œìš©

---

### 2.2 MessageQueryService ìƒì„±
**ìœ„ì¹˜:** `chat-system-server/src/main/java/com/example/chat/system/application/service/MessageQueryService.java`

**êµ¬í˜„ ë©”ì„œë“œ:**
```java
// ë©”ì‹œì§€ ì¡°íšŒ (ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§•)
public CursorPageResponse<MessageResponse> getMessages(
    String channelId, 
    String cursor, 
    int limit
);

// íŠ¹ì • ë©”ì‹œì§€ ì¡°íšŒ
public MessageResponse getMessage(String messageId);

// ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ
public long getUnreadMessageCount(String channelId);
```

**ì»¤ì„œ ìƒì„± ë°©ì‹:**
```java
// Cursor = Base64(messageId + ":" + createdAt.toEpochMilli())
String cursor = Base64.encode(message.getId() + ":" + message.getCreatedAt().toEpochMilli());
```

---

### 2.3 Controller ìƒì„±
**ìœ„ì¹˜:** `chat-system-server/src/main/java/com/example/chat/system/controller/MessageQueryController.java`

**ì—”ë“œí¬ì¸íŠ¸:**
```
GET /api/v1/messages?channelId={channelId}&cursor={cursor}&limit={limit}
GET /api/v1/messages/{messageId}
GET /api/v1/messages/unread-count?channelId={channelId}
```

---

## ğŸ“‹ Step 3: WebSocket Server ë¦¬íŒ©í† ë§

### 3.1 Domain ëª¨ë¸ ì ìš©
**ê¸°ì¡´ ë¬¸ì œ:**
- chat-websocket-serverê°€ Domain ëª¨ë¸ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- ë…ìì ì¸ DTO ì‚¬ìš©

**ê°œì„ :**
- `chat-domain` ëª¨ë“ˆ ì˜ì¡´ì„± ì¶”ê°€
- Domain ëª¨ë¸ í™œìš© (Message, Channel ë“±)

---

### 3.2 Redis Pub/Sub ì—°ë™ í™•ì¸
**íë¦„:**
1. chat-message-serverì—ì„œ ë©”ì‹œì§€ ë°œí–‰ (Redis Pub)
2. chat-websocket-server(ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤)ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  (Redis Sub)
3. ì—°ê²°ëœ WebSocket ì„¸ì…˜ì— ë©”ì‹œì§€ ì „ì†¡

**í™•ì¸ ì‚¬í•­:**
- RedisMessageListener ì •ìƒ ë™ì‘ í™•ì¸
- ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œ ì¤‘ë³µ ì „ì†¡ ë°©ì§€

---

### 3.3 ChatRoomSessionManager ë¦¬íŒ©í† ë§
**ê¸°ì¡´ ë¬¸ì œ:**
- ë¡œì»¬ ë©”ëª¨ë¦¬ ê¸°ë°˜ (ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ëŒ€ì‘ ë¶ˆê°€)

**ê°œì„ :**
- Redis ê¸°ë°˜ Session ê´€ë¦¬
- `RedisTemplate`ì„ í™œìš©í•œ ì±„ë„ë³„ ì„¸ì…˜ ê´€ë¦¬
- TTL ì„¤ì • (ì„¸ì…˜ ë§Œë£Œ ì²˜ë¦¬)

**êµ¬í˜„:**
```java
public class RedisChatRoomSessionManager {
    private final RedisTemplate<String, Set<String>> redisTemplate;
    
    public void addSession(String channelId, String sessionId) {
        String key = "channel:sessions:" + channelId;
        redisTemplate.opsForSet().add(key, sessionId);
        redisTemplate.expire(key, 24, TimeUnit.HOURS);
    }
    
    public Set<String> getSessions(String channelId) {
        String key = "channel:sessions:" + channelId;
        return redisTemplate.opsForSet().members(key);
    }
    
    public void removeSession(String channelId, String sessionId) {
        String key = "channel:sessions:" + channelId;
        redisTemplate.opsForSet().remove(key, sessionId);
    }
}
```

---

## ğŸ“‹ Step 4: í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±

### 4.1 Domain Service ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
**ìœ„ì¹˜:** `chat-domain/src/test/java/com/example/chat/domain/service/`

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**
```java
// MessageDomainServiceTest
@Test
void createTextMessage_success()
@Test
void createTextMessage_channelNotActive_throwsException()
@Test
void createTextMessage_userNotMember_throwsException()
@Test
void createTextMessage_userBanned_throwsException()

// ChannelDomainServiceTest
@Test
void createDirectChannel_success()
@Test
void createDirectChannel_sameUser_throwsException()
@Test
void addMemberToChannel_success()
@Test
void addMemberToChannel_alreadyMember_throwsException()
```

---

### 4.2 Application Service í†µí•© í…ŒìŠ¤íŠ¸
**ìœ„ì¹˜:** `chat-system-server/src/test/java/com/example/chat/system/application/service/`

**í…ŒìŠ¤íŠ¸ ì„¤ì •:**
- `@SpringBootTest`
- `@Transactional`
- Test Container (PostgreSQL, Redis)

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**
```java
// ChannelApplicationServiceTest
@Test
void createDirectChannel_success()
@Test
void addMemberToChannel_success()

// MessageQueryServiceTest
@Test
void getMessages_cursorPagination_success()
```

---

### 4.3 API ì—”ë“œíˆ¬ì—”ë“œ í…ŒìŠ¤íŠ¸
**ìœ„ì¹˜:** `chat-system-server/src/test/java/com/example/chat/system/controller/`

**í…ŒìŠ¤íŠ¸ ì„¤ì •:**
- `@WebMvcTest` ë˜ëŠ” `@SpringBootTest(webEnvironment = RANDOM_PORT)`
- MockMvc ë˜ëŠ” RestAssured

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**
```java
// ChannelControllerTest
@Test
void createDirectChannel_validRequest_returns201()
@Test
void createDirectChannel_invalidRequest_returns400()

// MessageQueryControllerTest
@Test
void getMessages_validCursor_returns200()
```

---

## ğŸ“‹ Step 5: ë¬¸ì„œí™” ë° ì •ë¦¬

### 5.1 API ë¬¸ì„œ ì‘ì„±
- Swagger/OpenAPI ì„¤ì • í™•ì¸
- ê° API ì—”ë“œí¬ì¸íŠ¸ ì˜ˆì‹œ ìš”ì²­/ì‘ë‹µ ì¶”ê°€

### 5.2 README ì—…ë°ì´íŠ¸
- í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ëª…
- ì‹¤í–‰ ë°©ë²•
- API ë¬¸ì„œ ë§í¬

### 5.3 ë¶ˆí•„ìš”í•œ íŒŒì¼ ì •ë¦¬
- `.bak` íŒŒì¼ ì œê±°
- ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” íŒ¨í‚¤ì§€/í´ë˜ìŠ¤ ì œê±°

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### Domain Service
- [x] MessageDomainService ë¦¬íŒ©í† ë§
- [x] ChannelDomainService ë¦¬íŒ©í† ë§
- [x] ScheduleDomainService ë¦¬íŒ©í† ë§
- [x] Early Return íŒ¨í„´ ì ìš©
- [x] Aggregate ê¸°ë°˜ í˜‘ë ¥

### Application Service
- [x] MessageApplicationService êµ¬í˜„
- [x] ScheduleService ë¦¬íŒ©í† ë§
- [ ] ChannelApplicationService êµ¬í˜„
- [ ] MessageQueryService êµ¬í˜„

### Controller
- [ ] ChannelController êµ¬í˜„
- [ ] MessageQueryController êµ¬í˜„

### Storage
- [ ] MessageRepository ì»¤ì„œ í˜ì´ì§• êµ¬í˜„
- [ ] ChannelRepository í™•ì¥

### WebSocket
- [ ] Domain ëª¨ë¸ ì ìš©
- [ ] Redis Session Manager êµ¬í˜„
- [ ] ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ëŒ€ì‘

### í…ŒìŠ¤íŠ¸
- [ ] Domain Service ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] Application Service í†µí•© í…ŒìŠ¤íŠ¸
- [ ] Controller API í…ŒìŠ¤íŠ¸

---

## ğŸš€ ì˜ˆìƒ ì†Œìš” ì‹œê°„

- Step 1: Channel ê´€ë¦¬ ê¸°ëŠ¥ - **2ì‹œê°„**
- Step 2: ë©”ì‹œì§€ ì¡°íšŒ ê¸°ëŠ¥ - **1.5ì‹œê°„**
- Step 3: WebSocket Server ë¦¬íŒ©í† ë§ - **1.5ì‹œê°„**
- Step 4: í†µí•© í…ŒìŠ¤íŠ¸ - **2ì‹œê°„**
- Step 5: ë¬¸ì„œí™” ë° ì •ë¦¬ - **1ì‹œê°„**

**ì´ ì˜ˆìƒ ì‹œê°„: 8ì‹œê°„**

---

## ğŸ’¡ ì£¼ì˜ì‚¬í•­

1. **DDD íŒ¨í„´ ì¤€ìˆ˜:**
   - Application ServiceëŠ” Aggregate ì¡°íšŒ + Domain Service í˜¸ì¶œ
   - Domain ServiceëŠ” Aggregate í˜‘ë ¥ ì¡°ìœ¨
   - Early Return íŒ¨í„´ ì¼ê´€ ì ìš©

2. **ì½”ë“œ ì»¨ë²¤ì…˜:**
   - ì£¼ì„ ì‘ì„± (ë„ë©”ì¸ ê·œì¹™ ëª…í™•íˆ)
   - ì…ë ¥ê°’ ê²€ì¦ (Early Validation)
   - ì±…ì„ ëª…í™•í™” (Single Responsibility)

3. **í…ŒìŠ¤íŠ¸ ì‘ì„±:**
   - í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸
   - Given-When-Then íŒ¨í„´ ì‚¬ìš©
   - ì˜ë¯¸ ìˆëŠ” í…ŒìŠ¤íŠ¸ëª…

4. **ì„±ëŠ¥ ê³ ë ¤:**
   - ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§• (Offset í˜ì´ì§• ì§€ì–‘)
   - N+1 ë¬¸ì œ ë°©ì§€ (Fetch Join í™œìš©)
   - Redis ìºì‹± ê³ ë ¤

---

**ì‘ì„±ì:** GitHub Copilot  
**ìƒíƒœ:** ì¤€ë¹„ ì™„ë£Œ  
**ì‹œì‘ ì˜ˆì •:** ë‹¤ìŒ ì„¸ì…˜
