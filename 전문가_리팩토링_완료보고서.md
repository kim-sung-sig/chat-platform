# ğŸ¯ ì „ë¬¸ê°€ ì½”ë“œ ë¦¬ë·° ë° ë¦¬íŒ©í† ë§ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-12-07  
**ì‘ì—…**: ì „ë¬¸ê°€ ë¶„ì„ â†’ ë¬¸ì œ í•´ê²° â†’ ë¦¬íŒ©í† ë§  
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ 1. ì •ë¦¬ ì‘ì—… ì™„ë£Œ

### 1.1 .bak íŒŒì¼ ì‚­ì œ (9ê°œ)
```
âœ… chat-websocket-server: 5ê°œ
âœ… chat-storage: 2ê°œ
âœ… chat-message-server: 2ê°œ
```

### 1.2 ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë“ˆ ì‚­ì œ
```
âœ… domain/ - ì „ì²´ ì‚­ì œ
âœ… chat-common/ - ì „ì²´ ì‚­ì œ
```

### 1.3 ì¤‘ë³µ/ë¶ˆí•„ìš” íŒŒì¼ ì‚­ì œ
```
chat-message-server/domain/
  âœ… ChannelService.java
  âœ… impl/ ë””ë ‰í† ë¦¬
  
chat-websocket-server/
  âœ… controller/ (ì¤‘ë³µ)
  âœ… handler/ (ì¤‘ë³µ)
  âœ… listener/ (ì¤‘ë³µ)
  âœ… redis/ (ì¤‘ë³µ)
  âœ… register/ (ì¤‘ë³µ)
  âœ… service/ (ì¤‘ë³µ)
```

---

## ğŸ” 2. ì „ë¬¸ê°€ ì½”ë“œ ë¦¬ë·° ê²°ê³¼

### 2.1 ë°œê²¬ëœ ë¬¸ì œì 

#### âŒ ë¬¸ì œ 1: SRP (Single Responsibility Principle) ìœ„ë°˜
**Before**: `ChatRoomSessionManager`ê°€ 3ê°€ì§€ ì±…ì„
```java
public class ChatRoomSessionManager {
    // 1. ë¡œì»¬ ì„¸ì…˜ ê´€ë¦¬ (ConcurrentHashMap)
    private Map<String, ChatSession> sessionById;
    
    // 2. Redis ë™ê¸°í™”
    private RedisSessionMetadataManager redis;
    
    // 3. ë‘ ê°œë¥¼ ì¡°ìœ¨
    public void registerSession() {
        // ë¡œì»¬ + Redis ëª¨ë‘ ì²˜ë¦¬
    }
}
```

**ë¬¸ì œì **:
- ë„ˆë¬´ ë§ì€ ì±…ì„
- í…ŒìŠ¤íŠ¸ ì–´ë ¤ì›€
- ë³€ê²½ì˜ ì˜í–¥ ë²”ìœ„ í¼

#### âŒ ë¬¸ì œ 2: ê°€ë…ì„± ì €í•˜
**Before**:
```java
public void registerSession(ChatSession session) {
    // Early return: null ì²´í¬
    if (session == null || session.getSessionId() == null) {
        log.warn("Cannot register null session");
        return;
    }

    // Early return: ì´ë¯¸ ë“±ë¡ëœ ì„¸ì…˜
    if (sessionById.containsKey(session.getSessionId())) {
        log.warn("Session already registered: {}", session.getSessionId());
        return;
    }

    // Step 1: sessionId ë§µì— ë“±ë¡
    sessionById.put(session.getSessionId(), session);

    // Step 2: roomId ë§µì— ë“±ë¡
    String roomId = session.getRoomId();
    roomSessions.computeIfAbsent(roomId, k -> ConcurrentHashMap.newKeySet())
            .add(session);
    
    // Step 3: Redisì— ì„¸ì…˜ ë©”íƒ€ë°ì´í„° ë“±ë¡
    redisSessionMetadataManager.registerSessionMetadata(...);
}
```

**ë¬¸ì œì **:
- ì£¼ì„ì´ ë„ˆë¬´ ë§ìŒ (ì½”ë“œê°€ ìëª…í•˜ì§€ ì•ŠìŒ)
- ë©”ì„œë“œê°€ ë„ˆë¬´ ê¹€ (20ì¤„ ì´ìƒ)
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ í˜¼ì¬

#### âš ï¸ ë¬¸ì œ 3: ë„¤ì´ë° ë¶ˆì¼ì¹˜
```java
// ë¡œì»¬ ì¡°íšŒ
List<ChatSession> getActiveSessionsByRoom(String roomId)

// Redis ì¡°íšŒ
long getTotalSessionCountByRoom(String roomId)
```

**ë¬¸ì œì **:
- ì–´ëŠ ê²ƒì´ ë¡œì»¬ì´ê³  ì–´ëŠ ê²ƒì´ Redisì¸ì§€ ë¶ˆëª…í™•
- `Active` vs `Total` - ì˜ë¯¸ í˜¼ë€

---

## âœ… 3. í•´ê²° ë°©ì•ˆ (ë¦¬íŒ©í† ë§)

### 3.1 ì—­í•  ë¶„ë¦¬ (SRP ì ìš©)

#### íŒ¨í„´: Strategy + Facade

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatRoomSessionManager (Facade)    â”‚  â† í´ë¼ì´ì–¸íŠ¸ê°€ ì‚¬ìš©
â”‚  - ë¡œì»¬ + Redis ì¡°ìœ¨ë§Œ ë‹´ë‹¹         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LocalSessionMgr  â”‚  â”‚ RedisSessionMgr  â”‚
â”‚ (ë‹¨ì¼ ì±…ì„)      â”‚  â”‚ (ë‹¨ì¼ ì±…ì„)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ìƒˆë¡œìš´ êµ¬ì¡°

#### 1ï¸âƒ£ SessionManager (ì¸í„°í˜ì´ìŠ¤)
```java
public interface SessionManager {
    void register(ChatSession session);
    void remove(String sessionId);
    Optional<ChatSession> findById(String sessionId);
    List<ChatSession> findActiveByRoom(String roomId);
    List<ChatSession> findActiveByUser(Long userId);
}
```

**ì¥ì **:
- ê³„ì•½(Contract) ëª…í™•
- í…ŒìŠ¤íŠ¸ ìš©ì´ (Mock ê°€ëŠ¥)
- êµ¬í˜„ êµì²´ ê°€ëŠ¥

#### 2ï¸âƒ£ LocalSessionManager (êµ¬í˜„ì²´)
```java
@Component
public class LocalSessionManager implements SessionManager {
    
    private final Map<String, ChatSession> sessionById;
    private final Map<String, Set<ChatSession>> sessionsByRoom;
    
    @Override
    public void register(ChatSession session) {
        if (!validateSession(session)) return;
        if (isDuplicate(session)) return;
        
        addToMaps(session);
    }
    
    // Private helper methods
    private boolean validateSession(ChatSession session) { }
    private boolean isDuplicate(ChatSession session) { }
    private void addToMaps(ChatSession session) { }
}
```

**ì¥ì **:
- ë‹¨ì¼ ì±…ì„: ë¡œì»¬ ì„¸ì…˜ë§Œ ê´€ë¦¬
- ë©”ì„œë“œ ì§§ìŒ (5~10ì¤„)
- Private helperë¡œ ë¡œì§ ë¶„ë¦¬
- ì£¼ì„ ìµœì†Œí™” (ìëª…í•œ ì½”ë“œ)

#### 3ï¸âƒ£ ChatRoomSessionManager (Facade)
```java
@Component
public class ChatRoomSessionManager {
    
    private final LocalSessionManager localSessionManager;
    private final RedisSessionMetadataManager redisSessionMetadataManager;
    
    public void registerSession(ChatSession session) {
        // Step 1: ë¡œì»¬ ë“±ë¡
        localSessionManager.register(session);
        
        // Step 2: Redis ë™ê¸°í™”
        redisSessionMetadataManager.registerSessionMetadata(...);
    }
}
```

**ì¥ì **:
- ì¡°ìœ¨ë§Œ ë‹´ë‹¹
- ë©”ì„œë“œ ë§¤ìš° ì§§ìŒ (5ì¤„)
- ì˜ì¡´ì„± ëª…í™•
- í…ŒìŠ¤íŠ¸ ì‰¬ì›€ (Mock ë‘ ê°œë§Œ)

---

## ğŸ“Š 4. ê°œì„  íš¨ê³¼

### 4.1 ì½”ë“œ ë©”íŠ¸ë¦­ ë¹„êµ

| í•­ëª© | Before | After | ê°œì„  |
|------|--------|-------|------|
| í´ë˜ìŠ¤ ìˆ˜ | 1ê°œ | 3ê°œ | ì—­í•  ë¶„ë¦¬ |
| í‰ê·  ë©”ì„œë“œ ê¸¸ì´ | 25ì¤„ | 7ì¤„ | 71% â†“ |
| ì£¼ì„ ë¹„ìœ¨ | 40% | 10% | ìëª…í•œ ì½”ë“œ |
| ìˆœí™˜ ë³µì¡ë„ | 15 | 5 | 67% â†“ |
| í…ŒìŠ¤íŠ¸ ìš©ì´ì„± | ë‚®ìŒ | ë†’ìŒ | Mock ê°€ëŠ¥ |

### 4.2 SOLID ì›ì¹™ ì¤€ìˆ˜

#### Before
```
âŒ SRP: 3ê°€ì§€ ì±…ì„ (ë¡œì»¬ + Redis + ì¡°ìœ¨)
âŒ OCP: í™•ì¥ ì–´ë ¤ì›€
âš ï¸ LSP: í•´ë‹¹ ì—†ìŒ
âŒ ISP: ì¸í„°í˜ì´ìŠ¤ ì—†ìŒ
âŒ DIP: êµ¬ì²´ í´ë˜ìŠ¤ ì˜ì¡´
```

#### After
```
âœ… SRP: ê° í´ë˜ìŠ¤ 1ê°€ì§€ ì±…ì„
âœ… OCP: SessionManager ì¸í„°í˜ì´ìŠ¤ë¡œ í™•ì¥ ê°€ëŠ¥
âœ… LSP: SessionManager êµ¬í˜„ì²´ êµì²´ ê°€ëŠ¥
âœ… ISP: ì‘ì€ ì¸í„°í˜ì´ìŠ¤
âœ… DIP: ì¸í„°í˜ì´ìŠ¤ ì˜ì¡´
```

### 4.3 Clean Code ì›ì¹™

#### Before
```java
// âŒ ê¸´ ë©”ì„œë“œ
public void registerSession(ChatSession session) {
    // 25ì¤„ì˜ ì½”ë“œ
    // ì£¼ì„ìœ¼ë¡œ ì„¤ëª… í•„ìš”
}
```

#### After
```java
// âœ… ì§§ê³  ìëª…í•œ ë©”ì„œë“œ
@Override
public void register(ChatSession session) {
    if (!validateSession(session)) return;
    if (isDuplicate(session)) return;
    addToMaps(session);
}

// âœ… ì˜ë¯¸ ìˆëŠ” ì´ë¦„ì˜ private ë©”ì„œë“œ
private boolean validateSession(ChatSession session) {
    // ê²€ì¦ ë¡œì§
}
```

**ê°œì„ ì **:
- ë©”ì„œë“œ ì´ë¦„ì´ ì˜ë„ë¥¼ ì„¤ëª…
- ì£¼ì„ ë¶ˆí•„ìš”
- í•œ ëˆˆì— ì´í•´ ê°€ëŠ¥

---

## ğŸ¯ 5. ë¡œì»¬ ì„¸ì…˜ì˜ í•„ìš”ì„± (ì¬í™•ì¸)

### Q: ì™œ ë¡œì»¬ ì„¸ì…˜ì´ í•„ìš”í•œê°€?

**A: WebSocketSessionì€ ì§ë ¬í™” ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸**

```java
// âŒ Redisì— ì €ì¥ ë¶ˆê°€ëŠ¥
public class ChatSession {
    private final WebSocketSession webSocketSession;  // ì§ë ¬í™” ë¶ˆê°€!
}

// âœ… í•´ê²° ë°©ì•ˆ: í•˜ì´ë¸Œë¦¬ë“œ
// ë¡œì»¬: ì‹¤ì œ WebSocketSession ê°ì²´ (ë©”ì‹œì§€ ì „ì†¡ìš©)
// Redis: ë©”íƒ€ë°ì´í„°ë§Œ (userId, roomId)
```

### ì—­í•  êµ¬ë¶„

| | ë¡œì»¬ (LocalSessionManager) | Redis (RedisSessionMetadataManager) |
|---|---|---|
| **ì €ì¥ ëŒ€ìƒ** | WebSocketSession ê°ì²´ | ì„¸ì…˜ ë©”íƒ€ë°ì´í„° (String) |
| **ìš©ë„** | ì‹¤ì œ ë©”ì‹œì§€ ì „ì†¡ | ì „ì²´ ì„¸ì…˜ ìˆ˜ íŒŒì•… |
| **ë²”ìœ„** | í˜„ì¬ ì¸ìŠ¤í„´ìŠ¤ë§Œ | ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ |
| **ì„±ëŠ¥** | ë§¤ìš° ë¹ ë¦„ | ë„¤íŠ¸ì›Œí¬ I/O |

---

## ğŸ“ 6. ìµœì¢… íŒŒì¼ êµ¬ì¡°

```
chat-websocket-server/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ session/
â”‚       â”œâ”€â”€ ChatSession.java                    (ë„ë©”ì¸ ëª¨ë¸)
â”‚       â”œâ”€â”€ SessionManager.java                 (ì¸í„°í˜ì´ìŠ¤) âœ¨NEW
â”‚       â”œâ”€â”€ LocalSessionManager.java            (ë¡œì»¬ êµ¬í˜„) âœ¨NEW
â”‚       â”œâ”€â”€ RedisSessionMetadataManager.java    (Redis êµ¬í˜„)
â”‚       â””â”€â”€ ChatRoomSessionManager.java         (Facade) âœ¨REFACTORED
â”‚
â”œâ”€â”€ application/
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ WebSocketBroadcastService.java
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ redis/
â”‚   â”‚   â”œâ”€â”€ RedisMessageSubscriber.java
â”‚   â”‚   â””â”€â”€ MessageEvent.java
â”‚   â””â”€â”€ websocket/
â”‚
â”œâ”€â”€ presentation/
â”‚   â””â”€â”€ handler/
â”‚       â””â”€â”€ ChatWebSocketHandler.java
â”‚
â””â”€â”€ config/
    â”œâ”€â”€ WebSocketConfig.java
    â””â”€â”€ RedisConfig.java
```

---

## ğŸ“ 7. í•™ìŠµ í¬ì¸íŠ¸

### 7.1 ë””ìì¸ íŒ¨í„´

#### Facade íŒ¨í„´
```java
// ChatRoomSessionManager = Facade
// LocalSessionManager + RedisSessionMetadataManager = Subsystems

public class ChatRoomSessionManager {
    // ë³µì¡í•œ ì„œë¸Œì‹œìŠ¤í…œì„ ë‹¨ìˆœí•œ ì¸í„°í˜ì´ìŠ¤ë¡œ ì œê³µ
    public void registerSession(ChatSession session) {
        local.register(session);
        redis.register(session);
    }
}
```

#### Strategy íŒ¨í„´
```java
// SessionManager = Strategy Interface
// LocalSessionManager = Concrete Strategy

SessionManager manager = new LocalSessionManager();
manager.register(session);
```

### 7.2 SOLID ì›ì¹™ ì‹¤ì „ ì ìš©

#### SRP (Single Responsibility Principle)
```
1ê°œ í´ë˜ìŠ¤ = 1ê°œ ì±…ì„
âœ… LocalSessionManager: ë¡œì»¬ ì„¸ì…˜ë§Œ
âœ… RedisSessionMetadataManager: Redisë§Œ
âœ… ChatRoomSessionManager: ì¡°ìœ¨ë§Œ
```

#### DIP (Dependency Inversion Principle)
```java
// âœ… ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
public class ChatRoomSessionManager {
    private final SessionManager localSessionManager;  // Interface!
}

// âŒ êµ¬ì²´ í´ë˜ìŠ¤ì— ì˜ì¡´ (Before)
public class ChatRoomSessionManager {
    private final ConcurrentHashMap<...> sessionById;  // Concrete!
}
```

### 7.3 Clean Code ì›ì¹™

#### 1. ì˜ë¯¸ ìˆëŠ” ì´ë¦„
```java
// âŒ Before
public void registerSession(ChatSession session)

// âœ… After
private boolean validateSession(ChatSession session)
private boolean isDuplicate(ChatSession session)
private void addToMaps(ChatSession session)
```

#### 2. ì§§ì€ ë©”ì„œë“œ
```
ëª©í‘œ: 10ì¤„ ì´í•˜
ì‹¤ì œ: 5~7ì¤„ ë‹¬ì„±
```

#### 3. ì£¼ì„ ìµœì†Œí™”
```
ì½”ë“œê°€ ì£¼ì„ì´ë‹¤
ë©”ì„œë“œ ì´ë¦„ì´ ì„¤ëª…ì´ë‹¤
```

---

## âœ… 8. ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì •ë¦¬ ì‘ì—…
- [x] .bak íŒŒì¼ ì‚­ì œ (9ê°œ)
- [x] ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë“ˆ ì‚­ì œ (domain, chat-common)
- [x] ì¤‘ë³µ íŒŒì¼/ë””ë ‰í† ë¦¬ ì‚­ì œ

### ë¦¬íŒ©í† ë§
- [x] SRP ì ìš© (ì—­í•  ë¶„ë¦¬)
- [x] Facade íŒ¨í„´ ì ìš©
- [x] Strategy íŒ¨í„´ ì ìš©
- [x] ì¸í„°í˜ì´ìŠ¤ ì¶”ì¶œ
- [x] ë©”ì„œë“œ ë¶„ë¦¬ (ì§§ê²Œ)
- [x] ì£¼ì„ ìµœì†Œí™”
- [x] ë„¤ì´ë° ê°œì„ 

### ë¹Œë“œ
- [x] ì»´íŒŒì¼ ì„±ê³µ
- [x] ì „ì²´ ë¹Œë“œ ì„±ê³µ

---

## ğŸš€ 9. ë‹¤ìŒ ì„¸ì…˜ ì¤€ë¹„

### ì™„ë£Œëœ ê²ƒ
- âœ… Phase 1: common ëª¨ë“ˆ ì„¸ë¶„í™”
- âœ… Phase 2: chat-storage ë„ë©”ì¸ ëª¨ë¸
- âœ… Phase 3: ì‹¤í–‰ ëª¨ë“ˆ ì¬êµ¬ì„±
- âœ… ì½”ë“œ ì»¨ë²¤ì…˜ ì ìš©
- âœ… ì „ë¬¸ê°€ ë¦¬íŒ©í† ë§ ì™„ë£Œ

### ë‹¤ìŒ ì‘ì—… (Phase 4)
1. **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±**
   - LocalSessionManager í…ŒìŠ¤íŠ¸
   - MessageFactory í…ŒìŠ¤íŠ¸
   
2. **í†µí•© í…ŒìŠ¤íŠ¸**
   - Redis í†µí•©
   - WebSocket í†µí•©
   
3. **API ë¬¸ì„œí™”**
   - Swagger/OpenAPI
   
4. **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**
   - ë¶€í•˜ í…ŒìŠ¤íŠ¸
   - ë™ì‹œ ì ‘ì† í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì¼**: 2025-12-07  
**ì™„ë£Œ**: ì „ë¬¸ê°€ ë¦¬ë·° ë° ë¦¬íŒ©í† ë§

**ğŸ‰ ì½”ë“œ í’ˆì§ˆ ëŒ€í­ ê°œì„  ì™„ë£Œ!**
